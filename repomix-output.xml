This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.github/workflows/deploy.yml
.gitignore
app/autenticacao/cadastrar/page.tsx
app/autenticacao/cadastro-sucesso/page.tsx
app/autenticacao/confirmar/route.ts
app/autenticacao/entrar/page.tsx
app/autenticacao/erro/page.tsx
app/autenticacao/esqueci-senha/page.tsx
app/autenticacao/redefinir-senha/page.tsx
app/dashboard/clientes/actions/cadastrarCliente.ts
app/dashboard/clientes/actions/listarClientes.ts
app/dashboard/clientes/page.tsx
app/dashboard/orcamentos/[id]/page.tsx
app/dashboard/orcamentos/actions/atualizarTitulo.ts
app/dashboard/orcamentos/actions/salvarFluxoOrcamento.ts
app/dashboard/orcamentos/page.tsx
app/globals.css
app/icon.svg
app/layout.tsx
app/page.tsx
components.json
components/buttons/logout-button.tsx
components/dashboard-header.tsx
components/forms/forgot-password-form.tsx
components/forms/login-form.tsx
components/forms/sign-up-form.tsx
components/forms/update-password-form.tsx
components/modal/novo-cliente-modal.tsx
components/orcamento/grade-orcamento.tsx
components/orcamento/historico-versoes.tsx
components/ui/badge.tsx
components/ui/botaoSalvar.tsx
components/ui/button.tsx
components/ui/card.tsx
components/ui/checkbox.tsx
components/ui/dialog.tsx
components/ui/dropdown-menu.tsx
components/ui/input.tsx
components/ui/label.tsx
docker-compose.yml
Dockerfile
eslint.config.mjs
lib/database.types.ts
lib/supabase/client.ts
lib/supabase/proxy.ts
lib/supabase/server.ts
lib/utils.ts
next.config.ts
package.json
postcss.config.mjs
proxy.ts
README.md
tailwind.config.ts
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".github/workflows/deploy.yml">
name: Deploy Precifica

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            # 1. Entrar na pasta do projeto
            mkdir -p ~/Precifica
            cd ~/Precifica
            
            # 2. Sincronizar com o commit atual
            if [ ! -d ".git" ]; then
              echo "Repositório não encontrado localmente. Clonando..."
              find . -mindepth 1 -delete
              git clone https://github.com/WilmarFilho/Precifica.git .
            else
              echo "Sincronizando repositório existente..."
              git fetch origin main
              git reset --hard origin/main
            fi

            # 3. Docker Compose (Sempre com hífen conforme solicitado)
            # Nota: Certifique-se de ter o Alias ou a versão V1 instalada na VPS
            docker-compose down
            docker-compose up -d --build

            # 4. Limpeza de imagens antigas para poupar espaço
            docker image prune -f
</file>

<file path="app/autenticacao/cadastro-sucesso/page.tsx">
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";

export default function PaginaCadastroSucesso() {
  return (
    <div className="flex min-h-svh w-full items-center justify-center p-6 md:p-10">
      <div className="w-full max-w-sm">
        <div className="flex flex-col gap-6">
          <Card>
            <CardHeader>
              <CardTitle className="text-2xl">
                Cadastro realizado com sucesso!
              </CardTitle>
              <CardDescription>Confira seu e-mail para confirmar</CardDescription>
            </CardHeader>
            <CardContent>
              <p className="text-sm text-muted-foreground">
                Sua conta foi criada. Por favor, confirme seu cadastro pelo e-mail antes de acessar.
              </p>
            </CardContent>
          </Card>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/autenticacao/confirmar/route.ts">
import { createClient } from "@/lib/supabase/server";
import { type EmailOtpType } from "@supabase/supabase-js";
import { redirect } from "next/navigation";
import { type NextRequest } from "next/server";

export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url);
  const token_hash = searchParams.get("token_hash");
  const type = searchParams.get("type") as EmailOtpType | null;
  const next = searchParams.get("next") ?? "/";

  if (token_hash && type) {
    const supabase = await createClient();

    const { error } = await supabase.auth.verifyOtp({
      type,
      token_hash,
    });
    if (!error) {
      // redireciona usuário para a URL especificada ou para a raiz
      redirect(next);
    } else {
      // redireciona para página de erro com instruções
      redirect(`/autenticacao/erro?error=${error?.message}`);
    }
  }

  // redireciona para página de erro com instruções
  redirect(`/autenticacao/erro?error=No token hash or type`);
}
</file>

<file path="app/autenticacao/erro/page.tsx">
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Suspense } from "react";

async function ConteudoErro({
  searchParams,
}: {
  searchParams: Promise<{ error: string }>;
}) {
  const params = await searchParams;

  return (
    <>
      {params?.error ? (
        <p className="text-sm text-muted-foreground">
          Erro: {params.error}
        </p>
      ) : (
        <p className="text-sm text-muted-foreground">
          Ocorreu um erro não especificado.
        </p>
      )}
    </>
  );
}

export default function PaginaErro({
  searchParams,
}: {
  searchParams: Promise<{ error: string }>;
}) {
  return (
    <div className="flex min-h-svh w-full items-center justify-center p-6 md:p-10">
      <div className="w-full max-w-sm">
        <div className="flex flex-col gap-6">
          <Card>
            <CardHeader>
              <CardTitle className="text-2xl">
                Ocorreu um erro
              </CardTitle>
            </CardHeader>
            <CardContent>
              <Suspense>
                <ConteudoErro searchParams={searchParams} />
              </Suspense>
            </CardContent>
          </Card>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/dashboard/clientes/actions/cadastrarCliente.ts">
"use server";

import { z } from "zod";
import { revalidatePath } from "next/cache";
import { createClient } from "@/lib/supabase/server";

const schema = z.object({
  nome: z.string().min(2),
});

export async function cadastrarCliente(formData: FormData) {
  const data = Object.fromEntries(formData.entries());
  const parsed = schema.safeParse(data);
  if (!parsed.success) {
    return { error: parsed.error.flatten().fieldErrors.nome?.[0] || "Dados inválidos" };
  }

  const supabase = await createClient();
  const { error } = await supabase.from("clientes").insert({
    nome: parsed.data.nome,
    // O Supabase RLS deve garantir o auth.uid() automaticamente
  });
  if (error) {
    return { error: error.message };
  }
  revalidatePath("/dashboard/clientes");
  return { success: true };
}
</file>

<file path="app/dashboard/clientes/actions/listarClientes.ts">
import { createClient } from "@/lib/supabase/server";
import { Database } from "@/lib/database.types";

export async function listarClientes(busca: string = "") {
  const supabase = await createClient();
  let query = supabase.from("clientes").select("id, nome, created_at").order("created_at", { ascending: false });
  if (busca) {
    query = query.ilike("nome", `%${busca}%`);
  }
  const { data, error } = await query;
  if (error) return [];
  return data as Pick<Database["public"]["Tables"]["clientes"]["Row"], "id" | "nome" | "created_at">[];
}
</file>

<file path="app/icon.svg">
<svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
<rect width="32" height="32" rx="16" fill="#2563EB"/>
<path d="M18.7778 16C18.7778 15.4396 18.6149 14.8918 18.3096 14.4259C18.0044 13.9599 17.5706 13.5968 17.063 13.3823C16.5554 13.1679 15.9969 13.1118 15.4581 13.2211C14.9192 13.3304 14.4243 13.6003 14.0358 13.9965C13.6473 14.3928 13.3828 14.8976 13.2756 15.4472C13.1684 15.9969 13.2234 16.5665 13.4337 17.0843C13.6439 17.602 13.9999 18.0445 14.4567 18.3558C14.9136 18.6672 15.4506 18.8333 16 18.8333C16.7367 18.8333 17.4433 18.5348 17.9642 18.0035C18.4851 17.4721 18.7778 16.7514 18.7778 16ZM14.3333 16C14.3333 15.6638 14.4311 15.3351 14.6142 15.0555C14.7974 14.776 15.0577 14.5581 15.3622 14.4294C15.6667 14.3007 16.0018 14.2671 16.3252 14.3327C16.6485 14.3983 16.9454 14.5602 17.1785 14.7979C17.4116 15.0357 17.5703 15.3386 17.6346 15.6683C17.699 15.9981 17.6659 16.3399 17.5398 16.6506C17.4137 16.9612 17.2 17.2267 16.926 17.4135C16.6519 17.6003 16.3296 17.7 16 17.7C15.558 17.7 15.134 17.5209 14.8215 17.2021C14.5089 16.8833 14.3333 16.4509 14.3333 16ZM21 23.9333V8.06667C21 7.91638 20.9415 7.77224 20.8373 7.66597C20.7331 7.5597 20.5918 7.5 20.4444 7.5H11.5556C11.4082 7.5 11.2669 7.5597 11.1627 7.66597C11.0585 7.77224 11 7.91638 11 8.06667L11 23.9333C11 24.0836 11.0585 24.2278 11.1627 24.334C11.2669 24.4403 11.4082 24.5 11.5556 24.5H20.4444C20.5918 24.5 20.7331 24.4403 20.8373 24.334C20.9415 24.2278 21 24.0836 21 23.9333ZM12.1111 20.6502V11.3498C12.7419 11.1595 13.3161 10.8113 13.7812 10.3369C14.2464 9.8624 14.5878 9.27678 14.7743 8.63333H17.2257C17.4122 9.27678 17.7536 9.8624 18.2188 10.3369C18.6839 10.8113 19.2581 11.1595 19.8889 11.3498V20.6502C19.2581 20.8405 18.6839 21.1887 18.2188 21.6631C17.7536 22.1376 17.4122 22.7232 17.2257 23.3667H14.7743C14.5878 22.7232 14.2464 22.1376 13.7812 21.6631C13.3161 21.1887 12.7419 20.8405 12.1111 20.6502ZM18.4049 23.3667C18.6914 22.687 19.2225 22.1452 19.8889 21.853V23.3667H18.4049ZM19.8889 10.147C19.2225 9.85478 18.6914 9.31302 18.4049 8.63333H19.8889V10.147ZM13.5951 8.63333C13.3086 9.31302 12.7775 9.85478 12.1111 10.147V8.63333H13.5951ZM12.1111 21.853C12.7775 22.1452 13.3086 22.687 13.5951 23.3667H12.1111L12.1111 21.853Z" fill="white"/>
</svg>
</file>

<file path="components.json">
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": true,
  "tsx": true,
  "tailwind": {
    "config": "",
    "css": "app/globals.css",
    "baseColor": "neutral",
    "cssVariables": true,
    "prefix": ""
  },
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "iconLibrary": "lucide"
}
</file>

<file path="components/buttons/logout-button.tsx">
"use client";

import { createClient } from "@/lib/supabase/client";
import { Button } from "@/components/ui/button";
import { useRouter } from "next/navigation";

export function LogoutButton() {
  const router = useRouter();

  const logout = async () => {
    const supabase = createClient();
    await supabase.auth.signOut();
    router.push("/autenticacao/entrar");
  };

  return <Button onClick={logout}>Logout</Button>;
}
</file>

<file path="components/forms/forgot-password-form.tsx">
"use client";

import { cn } from "@/lib/utils";
import { createClient } from "@/lib/supabase/client";
import { Button } from "@/components/ui/button";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import Link from "next/link";
import { useState } from "react";

export function ForgotPasswordForm({
  className,
  ...props
}: React.ComponentPropsWithoutRef<"div">) {
  const [email, setEmail] = useState("");
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState(false);
  const [isLoading, setIsLoading] = useState(false);

  const handleForgotPassword = async (e: React.FormEvent) => {
    e.preventDefault();
    const supabase = createClient();
    setIsLoading(true);
    setError(null);

    try {
      // The url which will be included in the email. This URL needs to be configured in your redirect URLs in the Supabase dashboard at https://supabase.com/dashboard/project/_/auth/url-configuration
      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: `${window.location.origin}/auth/update-password`,
      });
      if (error) throw error;
      setSuccess(true);
    } catch (error: unknown) {
      setError(error instanceof Error ? error.message : "An error occurred");
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className={cn("flex flex-col gap-6", className)} {...props}>
      {success ? (
        <Card>
          <CardHeader>
            <CardTitle className="text-2xl">Check Your Email</CardTitle>
            <CardDescription>Password reset instructions sent</CardDescription>
          </CardHeader>
          <CardContent>
            <p className="text-sm text-muted-foreground">
              If you registered using your email and password, you will receive
              a password reset email.
            </p>
          </CardContent>
        </Card>
      ) : (
        <Card>
          <CardHeader>
            <CardTitle className="text-2xl">Redefinir senha</CardTitle>
            <CardDescription>
              Informe seu e-mail e enviaremos um link para redefinir sua senha
            </CardDescription>
          </CardHeader>
          <CardContent>
            <form onSubmit={handleForgotPassword}>
              <div className="flex flex-col gap-6">
                <div className="grid gap-2">
                  <Label htmlFor="email">E-mail</Label>
                  <Input
                    id="email"
                    type="email"
                    placeholder="m@example.com"
                    required
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                  />
                </div>
                {error && <p className="text-sm text-red-500">{error}</p>}
                <Button type="submit" className="w-full" disabled={isLoading}>
                  {isLoading ? "Enviando..." : "Enviar e-mail de redefinição"}
                </Button>
              </div>
              <div className="mt-4 text-center text-sm">
                Já possui uma conta?{" "}
                <Link
                  href="/autenticacao/entrar"
                  className="underline underline-offset-4"
                >
                  Entrar
                </Link>
              </div>
            </form>
          </CardContent>
        </Card>
      )}
    </div>
  );
}
</file>

<file path="components/forms/login-form.tsx">
"use client";

import { cn } from "@/lib/utils";
import { createClient } from "@/lib/supabase/client";
import { Button } from "@/components/ui/button";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { useState } from "react";

export function LoginForm({
  className,
  ...props
}: React.ComponentPropsWithoutRef<"div">) {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const router = useRouter();

  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    const supabase = createClient();
    setIsLoading(true);
    setError(null);

    try {
      const { error } = await supabase.auth.signInWithPassword({
        email,
        password,
      });
      if (error) throw error;
      // Update this route to redirect to an authenticated route. The user already has an active session.
      router.push("/dashboard/orcamentos");
    } catch (error: unknown) {
      setError(error instanceof Error ? error.message : "An error occurred");
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className={cn("flex flex-col gap-6", className)} {...props}>
      <Card>
        <CardHeader>
          <CardTitle className="text-2xl">Entrar</CardTitle>
          <CardDescription>
            Informe seu e-mail para acessar sua conta
          </CardDescription>
        </CardHeader>
        <CardContent>
          <form onSubmit={handleLogin}>
            <div className="flex flex-col gap-6">
              <div className="grid gap-2">
                <Label htmlFor="email">Email</Label>
                <Input
                  id="email"
                  type="email"
                  placeholder="m@example.com"
                  required
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                />
              </div>
              <div className="grid gap-2">
                <div className="flex items-center">
                  <Label htmlFor="password">Senha</Label>
                  <Link
                    href="/autenticacao/esqueci-senha"
                    className="ml-auto inline-block text-sm underline-offset-4 hover:underline"
                  >
                    Esqueceu a senha?
                  </Link>
                </div>
                <Input
                  id="password"
                  type="password"
                  required
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                />
              </div>
              {error && <p className="text-sm text-red-500">{error}</p>}
              <Button type="submit" className="w-full" disabled={isLoading}>
                {isLoading ? "Entrando..." : "Entrar"}
              </Button>
            </div>
            <div className="mt-4 text-center text-sm">
              Não possui uma conta?{" "}
              <Link
                href="/autenticacao/cadastrar"
                className="underline underline-offset-4"
              >
                Sign up
              </Link>
            </div>
          </form>
        </CardContent>
      </Card>
    </div>
  );
}
</file>

<file path="components/forms/sign-up-form.tsx">
"use client";

import { cn } from "@/lib/utils";
import { createClient } from "@/lib/supabase/client";
import { Button } from "@/components/ui/button";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { useState } from "react";

export function SignUpForm({
  className,
  ...props
}: React.ComponentPropsWithoutRef<"div">) {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [repeatPassword, setRepeatPassword] = useState("");
  const [error, setError] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const router = useRouter();

  const handleSignUp = async (e: React.FormEvent) => {
    e.preventDefault();
    const supabase = createClient();
    setIsLoading(true);
    setError(null);

    if (password !== repeatPassword) {
        setError("As senhas não coincidem");
      setIsLoading(false);
      return;
    }

    try {
      const { error } = await supabase.auth.signUp({
        email,
        password,
        options: {
          emailRedirectTo: `${window.location.origin}/protected`,
        },
      });
      if (error) throw error;
        router.push("/autenticacao/cadastro-sucesso");
    } catch (error: unknown) {
      setError(error instanceof Error ? error.message : "An error occurred");
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className={cn("flex flex-col gap-6", className)} {...props}>
      <Card>
        <CardHeader>
            <CardTitle className="text-2xl">Cadastrar</CardTitle>
            <CardDescription>Crie uma nova conta</CardDescription>
        </CardHeader>
        <CardContent>
          <form onSubmit={handleSignUp}>
            <div className="flex flex-col gap-6">
              <div className="grid gap-2">
                  <Label htmlFor="email">E-mail</Label>
                <Input
                  id="email"
                  type="email"
                  placeholder="m@example.com"
                  required
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                />
              </div>
              <div className="grid gap-2">
                <div className="flex items-center">
                  <Label htmlFor="password">Password</Label>
                </div>
                <Input
                  id="password"
                  type="password"
                  required
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                />
              </div>
              <div className="grid gap-2">
                <div className="flex items-center">
                  <Label htmlFor="repeat-password">Repeat Password</Label>
                </div>
                <Input
                  id="repeat-password"
                  type="password"
                  required
                  value={repeatPassword}
                  onChange={(e) => setRepeatPassword(e.target.value)}
                />
              </div>
              {error && <p className="text-sm text-red-500">{error}</p>}
              <Button type="submit" className="w-full" disabled={isLoading}>
                {isLoading ? "Creating an account..." : "Sign up"}
              </Button>
            </div>
              <div className="mt-4 text-center text-sm">
                Já possui uma conta?{" "}
                <Link
                  href="/autenticacao/entrar"
                  className="underline underline-offset-4"
                >
                  Entrar
                </Link>
              </div>
          </form>
        </CardContent>
      </Card>
    </div>
  );
}
</file>

<file path="components/forms/update-password-form.tsx">
"use client";

import { cn } from "@/lib/utils";
import { createClient } from "@/lib/supabase/client";
import { Button } from "@/components/ui/button";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { useRouter } from "next/navigation";
import { useState } from "react";

export function UpdatePasswordForm({
  className,
  ...props
}: React.ComponentPropsWithoutRef<"div">) {
  const [password, setPassword] = useState("");
  const [error, setError] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const router = useRouter();

  const handleForgotPassword = async (e: React.FormEvent) => {
    e.preventDefault();
    const supabase = createClient();
    setIsLoading(true);
    setError(null);

    try {
      const { error } = await supabase.auth.updateUser({ password });
      if (error) throw error;
      // Update this route to redirect to an authenticated route. The user already has an active session.
      router.push("/protected");
    } catch (error: unknown) {
      setError(error instanceof Error ? error.message : "An error occurred");
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className={cn("flex flex-col gap-6", className)} {...props}>
      <Card>
        <CardHeader>
          <CardTitle className="text-2xl">Redefinir senha</CardTitle>
          <CardDescription>
            Informe sua nova senha abaixo.
          </CardDescription>
        </CardHeader>
        <CardContent>
          <form onSubmit={handleForgotPassword}>
            <div className="flex flex-col gap-6">
              <div className="grid gap-2">
                <Label htmlFor="password">Nova senha</Label>
                <Input
                  id="password"
                  type="password"
                  placeholder="Nova senha"
                  required
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                />
              </div>
              {error && <p className="text-sm text-red-500">{error}</p>}
              <Button type="submit" className="w-full" disabled={isLoading}>
                {isLoading ? "Salvando..." : "Salvar nova senha"}
              </Button>
            </div>
          </form>
        </CardContent>
      </Card>
    </div>
  );
}
</file>

<file path="components/modal/novo-cliente-modal.tsx">
'use client';

import { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { X, UserPlus, Loader2 } from 'lucide-react';
import { useRouter } from 'next/navigation';
import { createClient } from '@/lib/supabase/client';

export function NovoClienteModal() {
  const [isOpen, setIsOpen] = useState(false);
  const [loading, setLoading] = useState(false);
  const [nome, setNome] = useState('');
  const router = useRouter();
  const supabase = createClient();

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);

    const { data: { user } } = await supabase.auth.getUser();
    
    const { error } = await supabase
      .from('clientes')
      .insert([{ nome, user_id: user?.id }]);

    if (!error) {
      setNome('');
      setIsOpen(false);
      router.refresh();
    }
    setLoading(false);
  };

  return (
    <>
      <button 
        onClick={() => setIsOpen(true)}
        className="w-full md:w-auto whitespace-nowrap bg-blue-600 text-white font-bold px-6 py-3.5 rounded-xl shadow-lg shadow-blue-900/20 hover:bg-blue-500 transition uppercase text-xs flex items-center justify-center gap-2"
      >
        <UserPlus size={16} />
        Novo Cliente
      </button>

      <AnimatePresence>
        {isOpen && (
          <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
            {/* Overlay */}
            <motion.div 
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              onClick={() => setIsOpen(false)}
              className="absolute inset-0 bg-black/60 backdrop-blur-sm"
            />

            {/* Modal Card */}
            <motion.div 
              initial={{ opacity: 0, scale: 0.95, y: 20 }}
              animate={{ opacity: 1, scale: 1, y: 0 }}
              exit={{ opacity: 0, scale: 0.95, y: 20 }}
              className="relative w-full max-w-md bg-zinc-900 border border-zinc-800 rounded-3xl shadow-2xl overflow-hidden"
            >
              <div className="p-8">
                <div className="flex justify-between items-center mb-6">
                  <h2 className="text-2xl font-black text-white uppercase tracking-tight">Novo Cliente</h2>
                  <button onClick={() => setIsOpen(false)} className="text-zinc-500 hover:text-white transition">
                    <X size={24} />
                  </button>
                </div>

                <form onSubmit={handleSubmit} className="space-y-6">
                  <div>
                    <label className="text-[10px] font-bold uppercase text-zinc-500 mb-2 block tracking-widest">
                      Nome Completo ou Razão Social
                    </label>
                    <input 
                      autoFocus
                      required
                      type="text" 
                      value={nome}
                      onChange={(e) => setNome(e.target.value)}
                      placeholder="Ex: Gráfica Premium LTDA"
                      className="w-full bg-zinc-950 border border-zinc-800 rounded-2xl p-4 text-white outline-none focus:ring-2 focus:ring-blue-500/50 transition placeholder:text-zinc-700"
                    />
                  </div>

                  <div className="flex gap-3">
                    <button 
                      type="button"
                      onClick={() => setIsOpen(false)}
                      className="flex-1 px-6 py-4 rounded-2xl bg-zinc-800 text-white font-bold text-xs uppercase hover:bg-zinc-700 transition"
                    >
                      Cancelar
                    </button>
                    <button 
                      type="submit"
                      disabled={loading}
                      className="flex-[2] px-6 py-4 rounded-2xl bg-blue-600 text-white font-black text-xs uppercase hover:bg-blue-500 shadow-lg shadow-blue-900/20 transition flex items-center justify-center gap-2 disabled:opacity-50"
                    >
                      {loading ? <Loader2 className="animate-spin" size={16} /> : "Cadastrar Cliente"}
                    </button>
                  </div>
                </form>
              </div>
            </motion.div>
          </div>
        )}
      </AnimatePresence>
    </>
  );
}
</file>

<file path="components/ui/badge.tsx">
import * as React from "react";
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/lib/utils";

const badgeVariants = cva(
  "inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground shadow hover:bg-primary/80",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
        destructive:
          "border-transparent bg-destructive text-destructive-foreground shadow hover:bg-destructive/80",
        outline: "text-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  },
);

export interface BadgeProps
  extends React.HTMLAttributes<HTMLDivElement>,
    VariantProps<typeof badgeVariants> {}

function Badge({ className, variant, ...props }: BadgeProps) {
  return (
    <div className={cn(badgeVariants({ variant }), className)} {...props} />
  );
}

export { Badge, badgeVariants };
</file>

<file path="components/ui/botaoSalvar.tsx">
'use client';
import { useFormStatus } from 'react-dom';
import { Loader2, Plus } from 'lucide-react';

export function BotaoSalvar() {
  const { pending } = useFormStatus();

  return (
    <button 
      type="submit" 
      disabled={pending}
      className="w-full md:w-auto px-8 py-5 rounded-xl bg-blue-600 text-white font-black hover:bg-blue-500 shadow-lg shadow-blue-900/20 transition text-xs uppercase flex items-center justify-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed"
    >
      {pending ? (
        <Loader2 className="w-5 h-5 animate-spin" />
      ) : (
        <Plus className="w-5 h-5" />
      )}
      {pending ? 'Salvando...' : 'Salvar Versão'}
    </button>
  );
}
</file>

<file path="components/ui/button.tsx">
import * as React from "react";
import { Slot } from "@radix-ui/react-slot";
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/lib/utils";

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
  {
    variants: {
      variant: {
        default:
          "bg-primary text-primary-foreground shadow hover:bg-primary/90",
        destructive:
          "bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90",
        outline:
          "border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground",
        secondary:
          "bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/80",
        ghost: "hover:bg-accent hover:text-accent-foreground",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2",
        sm: "h-8 rounded-md px-3 text-xs",
        lg: "h-10 rounded-md px-8",
        icon: "h-9 w-9",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  },
);

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean;
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : "button";
    return (
      <Comp
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    );
  },
);
Button.displayName = "Button";

export { Button, buttonVariants };
</file>

<file path="components/ui/card.tsx">
import * as React from "react";

import { cn } from "@/lib/utils";

const Card = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "rounded-xl border bg-card text-card-foreground shadow",
      className,
    )}
    {...props}
  />
));
Card.displayName = "Card";

const CardHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex flex-col space-y-1.5 p-6", className)}
    {...props}
  />
));
CardHeader.displayName = "CardHeader";

const CardTitle = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("font-semibold leading-none tracking-tight", className)}
    {...props}
  />
));
CardTitle.displayName = "CardTitle";

const CardDescription = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
));
CardDescription.displayName = "CardDescription";

const CardContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
));
CardContent.displayName = "CardContent";

const CardFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex items-center p-6 pt-0", className)}
    {...props}
  />
));
CardFooter.displayName = "CardFooter";

export {
  Card,
  CardHeader,
  CardFooter,
  CardTitle,
  CardDescription,
  CardContent,
};
</file>

<file path="components/ui/checkbox.tsx">
"use client";

import * as React from "react";
import * as CheckboxPrimitive from "@radix-ui/react-checkbox";
import { Check } from "lucide-react";

import { cn } from "@/lib/utils";

const Checkbox = React.forwardRef<
  React.ElementRef<typeof CheckboxPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>
>(({ className, ...props }, ref) => (
  <CheckboxPrimitive.Root
    ref={ref}
    className={cn(
      "peer h-4 w-4 shrink-0 rounded-sm border border-primary shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",
      className,
    )}
    {...props}
  >
    <CheckboxPrimitive.Indicator
      className={cn("flex items-center justify-center text-current")}
    >
      <Check className="h-4 w-4" />
    </CheckboxPrimitive.Indicator>
  </CheckboxPrimitive.Root>
));
Checkbox.displayName = CheckboxPrimitive.Root.displayName;

export { Checkbox };
</file>

<file path="components/ui/dialog.tsx">
import * as React from "react";
import { Dialog as DialogPrimitive, DialogContent as DialogContentPrimitive } from "@radix-ui/react-dialog";

export const Dialog = DialogPrimitive;
export const DialogContent = DialogContentPrimitive;

export function DialogHeader({ children, className }: React.HTMLAttributes<HTMLDivElement>) {
	return (
		<div className={"flex flex-col space-y-1.5 p-6 " + (className ?? "")}>{children}</div>
	);
}

export function DialogTitle({ children, className }: React.HTMLAttributes<HTMLHeadingElement>) {
	return (
		<h2 className={"text-lg font-semibold leading-none tracking-tight " + (className ?? "")}>{children}</h2>
	);
}
</file>

<file path="components/ui/dropdown-menu.tsx">
"use client";

import * as React from "react";
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu";
import { Check, ChevronRight, Circle } from "lucide-react";

import { cn } from "@/lib/utils";

const DropdownMenu = DropdownMenuPrimitive.Root;

const DropdownMenuTrigger = DropdownMenuPrimitive.Trigger;

const DropdownMenuGroup = DropdownMenuPrimitive.Group;

const DropdownMenuPortal = DropdownMenuPrimitive.Portal;

const DropdownMenuSub = DropdownMenuPrimitive.Sub;

const DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup;

const DropdownMenuSubTrigger = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {
    inset?: boolean;
  }
>(({ className, inset, children, ...props }, ref) => (
  <DropdownMenuPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
      inset && "pl-8",
      className,
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto" />
  </DropdownMenuPrimitive.SubTrigger>
));
DropdownMenuSubTrigger.displayName =
  DropdownMenuPrimitive.SubTrigger.displayName;

const DropdownMenuSubContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]",
      className,
    )}
    {...props}
  />
));
DropdownMenuSubContent.displayName =
  DropdownMenuPrimitive.SubContent.displayName;

const DropdownMenuContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <DropdownMenuPrimitive.Portal>
    <DropdownMenuPrimitive.Content
      ref={ref}
      sideOffset={sideOffset}
      className={cn(
        "z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md",
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]",
        className,
      )}
      {...props}
    />
  </DropdownMenuPrimitive.Portal>
));
DropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName;

const DropdownMenuItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {
    inset?: boolean;
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&>svg]:size-4 [&>svg]:shrink-0",
      inset && "pl-8",
      className,
    )}
    {...props}
  />
));
DropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName;

const DropdownMenuCheckboxItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <DropdownMenuPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className,
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.CheckboxItem>
));
DropdownMenuCheckboxItem.displayName =
  DropdownMenuPrimitive.CheckboxItem.displayName;

const DropdownMenuRadioItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <DropdownMenuPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className,
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.RadioItem>
));
DropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName;

const DropdownMenuLabel = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {
    inset?: boolean;
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Label
    ref={ref}
    className={cn(
      "px-2 py-1.5 text-sm font-semibold",
      inset && "pl-8",
      className,
    )}
    {...props}
  />
));
DropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName;

const DropdownMenuSeparator = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
));
DropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName;

const DropdownMenuShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn("ml-auto text-xs tracking-widest opacity-60", className)}
      {...props}
    />
  );
};
DropdownMenuShortcut.displayName = "DropdownMenuShortcut";

export {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuGroup,
  DropdownMenuPortal,
  DropdownMenuSub,
  DropdownMenuSubContent,
  DropdownMenuSubTrigger,
  DropdownMenuRadioGroup,
};
</file>

<file path="components/ui/input.tsx">
import * as React from "react";

import { cn } from "@/lib/utils";

const Input = React.forwardRef<HTMLInputElement, React.ComponentProps<"input">>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
          className,
        )}
        ref={ref}
        {...props}
      />
    );
  },
);
Input.displayName = "Input";

export { Input };
</file>

<file path="components/ui/label.tsx">
"use client";

import * as React from "react";
import * as LabelPrimitive from "@radix-ui/react-label";
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/lib/utils";

const labelVariants = cva(
  "text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",
);

const Label = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &
    VariantProps<typeof labelVariants>
>(({ className, ...props }, ref) => (
  <LabelPrimitive.Root
    ref={ref}
    className={cn(labelVariants(), className)}
    {...props}
  />
));
Label.displayName = LabelPrimitive.Root.displayName;

export { Label };
</file>

<file path="eslint.config.mjs">
import { dirname } from "path";
import { fileURLToPath } from "url";
import { FlatCompat } from "@eslint/eslintrc";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const compat = new FlatCompat({
  baseDirectory: __dirname,
});

const eslintConfig = [
  ...compat.extends("next/core-web-vitals", "next/typescript"),
];

export default eslintConfig;
</file>

<file path="lib/supabase/client.ts">
import { createBrowserClient } from "@supabase/ssr";

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!,
  );
}
</file>

<file path="lib/supabase/proxy.ts">
import { createServerClient } from "@supabase/ssr";
import { NextResponse, type NextRequest } from "next/server";
import { hasEnvVars } from "../utils";

export async function updateSession(request: NextRequest) {
  let supabaseResponse = NextResponse.next({
    request,
  });

  // If the env vars are not set, skip proxy check. You can remove this
  // once you setup the project.
  if (!hasEnvVars) {
    return supabaseResponse;
  }

  // With Fluid compute, don't put this client in a global environment
  // variable. Always create a new one on each request.
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll();
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value }) =>
            request.cookies.set(name, value),
          );
          supabaseResponse = NextResponse.next({
            request,
          });
          cookiesToSet.forEach(({ name, value, options }) =>
            supabaseResponse.cookies.set(name, value, options),
          );
        },
      },
    },
  );

  // Do not run code between createServerClient and
  // supabase.auth.getClaims(). A simple mistake could make it very hard to debug
  // issues with users being randomly logged out.

  // IMPORTANT: If you remove getClaims() and you use server-side rendering
  // with the Supabase client, your users may be randomly logged out.
  const { data } = await supabase.auth.getClaims();
  const user = data?.claims;

  if (
    request.nextUrl.pathname !== "/" &&
    !user &&
    !request.nextUrl.pathname.startsWith("/login") &&
    !request.nextUrl.pathname.startsWith("/auth")
  ) {
    // no user, potentially respond by redirecting the user to the login page
    const url = request.nextUrl.clone();
    url.pathname = "/auth/login";
    return NextResponse.redirect(url);
  }

  // IMPORTANT: You *must* return the supabaseResponse object as it is.
  // If you're creating a new response object with NextResponse.next() make sure to:
  // 1. Pass the request in it, like so:
  //    const myNewResponse = NextResponse.next({ request })
  // 2. Copy over the cookies, like so:
  //    myNewResponse.cookies.setAll(supabaseResponse.cookies.getAll())
  // 3. Change the myNewResponse object to fit your needs, but avoid changing
  //    the cookies!
  // 4. Finally:
  //    return myNewResponse
  // If this is not done, you may be causing the browser and server to go out
  // of sync and terminate the user's session prematurely!

  return supabaseResponse;
}
</file>

<file path="lib/supabase/server.ts">
import { createServerClient } from "@supabase/ssr";
import { cookies } from "next/headers";

/**
 * Especially important if using Fluid compute: Don't put this client in a
 * global variable. Always create a new client within each function when using
 * it.
 */
export async function createClient() {
  const cookieStore = await cookies();

  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll();
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options),
            );
          } catch {
            // The `setAll` method was called from a Server Component.
            // This can be ignored if you have proxy refreshing
            // user sessions.
          }
        },
      },
    },
  );
}
</file>

<file path="lib/utils.ts">
import { clsx, type ClassValue } from "clsx";
import { twMerge } from "tailwind-merge";

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}

// This check can be removed, it is just for tutorial purposes
export const hasEnvVars =
  process.env.NEXT_PUBLIC_SUPABASE_URL &&
  process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY;
</file>

<file path="postcss.config.mjs">
/** @type {import('postcss-load-config').Config} */
const config = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
};

export default config;
</file>

<file path="README.md">
<a href="https://demo-nextjs-with-supabase.vercel.app/">
  <img alt="Next.js and Supabase Starter Kit - the fastest way to build apps with Next.js and Supabase" src="https://demo-nextjs-with-supabase.vercel.app/opengraph-image.png">
  <h1 align="center">Next.js and Supabase Starter Kit</h1>
</a>

<p align="center">
 The fastest way to build apps with Next.js and Supabase
</p>

<p align="center">
  <a href="#features"><strong>Features</strong></a> ·
  <a href="#demo"><strong>Demo</strong></a> ·
  <a href="#deploy-to-vercel"><strong>Deploy to Vercel</strong></a> ·
  <a href="#clone-and-run-locally"><strong>Clone and run locally</strong></a> ·
  <a href="#feedback-and-issues"><strong>Feedback and issues</strong></a>
  <a href="#more-supabase-examples"><strong>More Examples</strong></a>
</p>
<br/>

## Features

- Works across the entire [Next.js](https://nextjs.org) stack
  - App Router
  - Pages Router
  - Proxy
  - Client
  - Server
  - It just works!
- supabase-ssr. A package to configure Supabase Auth to use cookies
- Password-based authentication block installed via the [Supabase UI Library](https://supabase.com/ui/docs/nextjs/password-based-auth)
- Styling with [Tailwind CSS](https://tailwindcss.com)
- Components with [shadcn/ui](https://ui.shadcn.com/)
- Optional deployment with [Supabase Vercel Integration and Vercel deploy](#deploy-your-own)
  - Environment variables automatically assigned to Vercel project

## Demo

You can view a fully working demo at [demo-nextjs-with-supabase.vercel.app](https://demo-nextjs-with-supabase.vercel.app/).

## Deploy to Vercel

Vercel deployment will guide you through creating a Supabase account and project.

After installation of the Supabase integration, all relevant environment variables will be assigned to the project so the deployment is fully functioning.

[![Deploy with Vercel](https://vercel.com/button)](https://vercel.com/new/clone?repository-url=https%3A%2F%2Fgithub.com%2Fvercel%2Fnext.js%2Ftree%2Fcanary%2Fexamples%2Fwith-supabase&project-name=nextjs-with-supabase&repository-name=nextjs-with-supabase&demo-title=nextjs-with-supabase&demo-description=This+starter+configures+Supabase+Auth+to+use+cookies%2C+making+the+user%27s+session+available+throughout+the+entire+Next.js+app+-+Client+Components%2C+Server+Components%2C+Route+Handlers%2C+Server+Actions+and+Middleware.&demo-url=https%3A%2F%2Fdemo-nextjs-with-supabase.vercel.app%2F&external-id=https%3A%2F%2Fgithub.com%2Fvercel%2Fnext.js%2Ftree%2Fcanary%2Fexamples%2Fwith-supabase&demo-image=https%3A%2F%2Fdemo-nextjs-with-supabase.vercel.app%2Fopengraph-image.png)

The above will also clone the Starter kit to your GitHub, you can clone that locally and develop locally.

If you wish to just develop locally and not deploy to Vercel, [follow the steps below](#clone-and-run-locally).

## Clone and run locally

1. You'll first need a Supabase project which can be made [via the Supabase dashboard](https://database.new)

2. Create a Next.js app using the Supabase Starter template npx command

   ```bash
   npx create-next-app --example with-supabase with-supabase-app
   ```

   ```bash
   yarn create next-app --example with-supabase with-supabase-app
   ```

   ```bash
   pnpm create next-app --example with-supabase with-supabase-app
   ```

3. Use `cd` to change into the app's directory

   ```bash
   cd with-supabase-app
   ```

4. Rename `.env.example` to `.env.local` and update the following:

  ```env
  NEXT_PUBLIC_SUPABASE_URL=[INSERT SUPABASE PROJECT URL]
  NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY=[INSERT SUPABASE PROJECT API PUBLISHABLE OR ANON KEY]
  ```
  > [!NOTE]
  > This example uses `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY`, which refers to Supabase's new **publishable** key format.
  > Both legacy **anon** keys and new **publishable** keys can be used with this variable name during the transition period. Supabase's dashboard may show `NEXT_PUBLIC_SUPABASE_ANON_KEY`; its value can be used in this example.
  > See the [full announcement](https://github.com/orgs/supabase/discussions/29260) for more information.

  Both `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY` can be found in [your Supabase project's API settings](https://supabase.com/dashboard/project/_?showConnect=true)

5. You can now run the Next.js local development server:

   ```bash
   npm run dev
   ```

   The starter kit should now be running on [localhost:3000](http://localhost:3000/).

6. This template comes with the default shadcn/ui style initialized. If you instead want other ui.shadcn styles, delete `components.json` and [re-install shadcn/ui](https://ui.shadcn.com/docs/installation/next)

> Check out [the docs for Local Development](https://supabase.com/docs/guides/getting-started/local-development) to also run Supabase locally.

## Feedback and issues

Please file feedback and issues over on the [Supabase GitHub org](https://github.com/supabase/supabase/issues/new/choose).

## More Supabase examples

- [Next.js Subscription Payments Starter](https://github.com/vercel/nextjs-subscription-payments)
- [Cookie-based Auth and the Next.js 13 App Router (free course)](https://youtube.com/playlist?list=PL5S4mPUpp4OtMhpnp93EFSo42iQ40XjbF)
- [Supabase Auth and the Next.js App Router](https://github.com/supabase/supabase/tree/master/examples/auth/nextjs)
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts"
  ],
  "exclude": ["node_modules"]
}
</file>

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*.local
.env

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts


.ssh
</file>

<file path="app/autenticacao/cadastrar/page.tsx">
import { SignUpForm } from "@/components/forms/sign-up-form";

export default function PaginaCadastro() {
  return (
    <div className="flex min-h-svh w-full items-center justify-center p-6 md:p-10">
      <div className="w-full max-w-sm">
        <SignUpForm />
      </div>
    </div>
  );
}
</file>

<file path="app/autenticacao/entrar/page.tsx">
import { LoginForm } from "@/components/forms/login-form";

export default function PaginaEntrar() {
  return (
    <div className="flex min-h-svh w-full items-center justify-center p-6 md:p-10">
      <div className="w-full max-w-sm">
        <LoginForm />
      </div>
    </div>
  );
}
</file>

<file path="app/autenticacao/esqueci-senha/page.tsx">
import { ForgotPasswordForm } from "@/components/forms/forgot-password-form";

export default function PaginaEsqueciSenha() {
  return (
    <div className="flex min-h-svh w-full items-center justify-center p-6 md:p-10">
      <div className="w-full max-w-sm">
        <ForgotPasswordForm />
      </div>
    </div>
  );
}
</file>

<file path="app/autenticacao/redefinir-senha/page.tsx">
import { UpdatePasswordForm } from "@/components/forms/update-password-form";

export default function PaginaRedefinirSenha() {
  return (
    <div className="flex min-h-svh w-full items-center justify-center p-6 md:p-10">
      <div className="w-full max-w-sm">
        <UpdatePasswordForm />
      </div>
    </div>
  );
}
</file>

<file path="app/dashboard/orcamentos/actions/atualizarTitulo.ts">
"use server";

import { createClient } from "@/lib/supabase/server";
import { revalidatePath } from "next/cache";

// No arquivo atualizarTitulo.ts

export async function atualizarTituloOrcamento(id: string, novoTitulo: string) {
  const supabase = await createClient();

  const { error } = await supabase
    .from("orcamentos")
    .update({ titulo: novoTitulo })
    .eq("id", id);

  if (error) throw new Error("Erro ao atualizar título");

  // Garanta que o caminho está correto (verifique se a pasta é /orcamentos ou /orcamento)
  revalidatePath(`/dashboard/orcamentos/${id}`);
  
  return { ok: true };
}
</file>

<file path="app/globals.css">
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  :root {
    font-family: 'Poppins', sans-serif;
    --background: 0 0% 100%;
    --foreground: 0 0% 3.9%;
    --card: 0 0% 100%;
    --card-foreground: 0 0% 3.9%;
    --popover: 0 0% 100%;
    --popover-foreground: 0 0% 3.9%;
    --primary: 0 0% 9%;
    --primary-foreground: 0 0% 98%;
    --secondary: 0 0% 96.1%;
    --secondary-foreground: 0 0% 9%;
    --muted: 0 0% 96.1%;
    --muted-foreground: 0 0% 45.1%;
    --accent: 0 0% 96.1%;
    --accent-foreground: 0 0% 9%;
    --destructive: 0 84.2% 60.2%;
    --destructive-foreground: 0 0% 98%;
    --border: 0 0% 89.8%;
    --input: 0 0% 89.8%;
    --ring: 0 0% 3.9%;
    --chart-1: 12 76% 61%;
    --chart-2: 173 58% 39%;
    --chart-3: 197 37% 24%;
    --chart-4: 43 74% 66%;
    --chart-5: 27 87% 67%;
    --radius: 0.5rem;
  }
  .dark {
    --background: 0 0% 3.9%;
    --foreground: 0 0% 98%;
    --card: 0 0% 3.9%;
    --card-foreground: 0 0% 98%;
    --popover: 0 0% 3.9%;
    --popover-foreground: 0 0% 98%;
    --primary: 0 0% 98%;
    --primary-foreground: 0 0% 9%;
    --secondary: 0 0% 14.9%;
    --secondary-foreground: 0 0% 98%;
    --muted: 0 0% 14.9%;
    --muted-foreground: 0 0% 63.9%;
    --accent: 0 0% 14.9%;
    --accent-foreground: 0 0% 98%;
    --destructive: 0 62.8% 30.6%;
    --destructive-foreground: 0 0% 98%;
    --border: 0 0% 14.9%;
    --input: 0 0% 14.9%;
    --ring: 0 0% 83.1%;
    --chart-1: 220 70% 50%;
    --chart-2: 160 60% 45%;
    --chart-3: 30 80% 55%;
    --chart-4: 280 65% 60%;
    --chart-5: 340 75% 55%;
  }
}

@layer base {
  * {
    @apply border-border;
  }
  body {
    @apply bg-background text-foreground;
  }
}
</file>

<file path="docker-compose.yml">
services:
  precifica-app:
    # Nome do serviço
    container_name: precifica-app
    # Indica que a imagem deve ser construída a partir do Dockerfile no diretório atual:
    build:
      context: .
      dockerfile: Dockerfile
    # Mapeamento de portas: 3002 da máquina host para 3002 do container
    # A porta 3002 é a porta fixa definida para o serviço.
    ports:
      - "3002:3002"
    # Reinicia o container se ele falhar
    restart: always
    # Carrega variáveis de ambiente do arquivo .env (local)
    env_file:
      - .env
</file>

<file path="Dockerfile">
# --- STAGE 1: BUILD ---
FROM node:20-alpine AS builder
WORKDIR /app

# Cache de dependências
COPY package.json package-lock.json ./
RUN npm install

COPY . .

# Desabilita telemetria durante o build
ENV NEXT_TELEMETRY_DISABLED 1

# IMPORTANTE: Para usar o standalone, seu next.config.js 
# deve ter: output: 'standalone'
RUN npm run build

# --- STAGE 2: RUNTIME ---
FROM node:20-alpine AS runner
WORKDIR /app

ENV NODE_ENV production
ENV NEXT_TELEMETRY_DISABLED 1
ENV PORT 3002

# Criar usuário de sistema para segurança
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# Ajuste para a pasta public: Copia apenas se existir
COPY --from=builder /app/package.json ./package.json
COPY --from=builder /app/.next/static ./.next/static

# Truque para copiar a pasta public apenas se ela existir no builder
# Isso evita o erro "file does not exist" que quebrou seu deploy
RUN if [ -d /app/public ]; then cp -r /app/public ./public; fi

# Copia o output standalone (requer a config no next.config.js)
# Isso já inclui os node_modules necessários, você não precisa copiar a pasta toda
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./

USER nextjs

EXPOSE 3002

# No modo standalone, rodamos o server.js diretamente com node, é muito mais rápido
CMD ["node", "server.js"]
</file>

<file path="proxy.ts">
import { updateSession } from "@/lib/supabase/proxy";
import { type NextRequest } from "next/server";

export async function proxy(request: NextRequest) {
  return await updateSession(request);
}

export const config = {
  matcher: [
    // Protege apenas rotas /dashboard (e subrotas)
    "/dashboard/:path*",
  ],
};
</file>

<file path="tailwind.config.ts">
import type { Config } from "tailwindcss";

export default {
  darkMode: "class",
  content: [
    "./pages/**/*.{js,ts,jsx,tsx,mdx}",
    "./components/**/*.{js,ts,jsx,tsx,mdx}",
    "./app/**/*.{js,ts,jsx,tsx,mdx}",
    "./src/**/*.{js,ts,jsx,tsx,mdx}",
  ],
  theme: {
    extend: {
      fontFamily: {
        sans: ["Poppins", "sans-serif"],
      },
      colors: {
        background: "hsl(var(--background))",
        foreground: "hsl(var(--foreground))",
        card: {
          DEFAULT: "hsl(var(--card))",
          foreground: "hsl(var(--card-foreground))",
        },
        popover: {
          DEFAULT: "hsl(var(--popover))",
          foreground: "hsl(var(--popover-foreground))",
        },
        primary: {
          DEFAULT: "hsl(var(--primary))",
          foreground: "hsl(var(--primary-foreground))",
        },
        secondary: {
          DEFAULT: "hsl(var(--secondary))",
          foreground: "hsl(var(--secondary-foreground))",
        },
        muted: {
          DEFAULT: "hsl(var(--muted))",
          foreground: "hsl(var(--muted-foreground))",
        },
        accent: {
          DEFAULT: "hsl(var(--accent))",
          foreground: "hsl(var(--accent-foreground))",
        },
        destructive: {
          DEFAULT: "hsl(var(--destructive))",
          foreground: "hsl(var(--destructive-foreground))",
        },
        border: "hsl(var(--border))",
        input: "hsl(var(--input))",
        ring: "hsl(var(--ring))",
        chart: {
          "1": "hsl(var(--chart-1))",
          "2": "hsl(var(--chart-2))",
          "3": "hsl(var(--chart-3))",
          "4": "hsl(var(--chart-4))",
          "5": "hsl(var(--chart-5))",
        },
      },
      borderRadius: {
        lg: "var(--radius)",
        md: "calc(var(--radius) - 2px)",
        sm: "calc(var(--radius) - 4px)",
      },
    },
  },
  plugins: [require("tailwindcss-animate")],
} satisfies Config;
</file>

<file path="components/dashboard-header.tsx">
'use client';

import { useState } from "react";
import Link from "next/link";
import { LogoutButton } from "@/components/buttons/logout-button";
import { Menu, X } from "lucide-react";

export function DashboardHeader() {
  const [isMenuOpen, setIsMenuOpen] = useState(false);

  const navLinks = [
    { href: "/dashboard/orcamentos", label: "Orçamentos" },
    { href: "/dashboard/clientes", label: "Clientes" },
  ];

  return (
    // Removido max-w-7xl e mx-auto daqui, pois o pai já controla isso
    <header className="w-full relative z-50 mb-8">
      <div 
        className={`w-full flex items-center justify-between py-4 px-6 md:px-10 transition-all duration-300 ${
          isMenuOpen ? "rounded-t-3xl border-b-0" : "rounded-full"
        } border border-white/10 bg-white/5 backdrop-blur-lg shadow-md`}
        style={{ background: "rgba(255,255,255,0.07)" }}
      >
        <Link href="/dashboard/orcamentos" className="font-extrabold text-lg tracking-wide text-white uppercase shrink-0">
          Precifica
        </Link>

        <nav className="hidden md:flex gap-8">
          {navLinks.map((link) => (
            <Link 
              key={link.href} 
              href={link.href} 
              className="text-white/80 hover:text-white font-medium transition text-sm uppercase tracking-wider"
            >
              {link.label}
            </Link>
          ))}
        </nav>

        <div className="hidden md:block">
          <LogoutButton />
        </div>

        <button className="md:hidden text-white p-2" onClick={() => setIsMenuOpen(!isMenuOpen)}>
          {isMenuOpen ? <X size={24} /> : <Menu size={24} />}
        </button>
      </div>

      {isMenuOpen && (
        <div className="md:hidden absolute left-0 right-0 border border-t-0 border-white/10 bg-[#121214] backdrop-blur-xl rounded-b-3xl shadow-xl overflow-hidden">
          <nav className="flex flex-col p-4 gap-2">
            {navLinks.map((link) => (
              <Link 
                key={link.href} 
                href={link.href}
                onClick={() => setIsMenuOpen(false)}
                className="text-white/80 hover:text-white hover:bg-white/5 p-4 rounded-xl font-medium transition text-sm uppercase"
              >
                {link.label}
              </Link>
            ))}
            <div className="border-t border-white/10 mt-2 pt-4 pb-2 px-4">
              <LogoutButton />
            </div>
          </nav>
        </div>
      )}
    </header>
  );
}
</file>

<file path="next.config.ts">
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
    output: 'standalone',
};

export default nextConfig;
</file>

<file path="app/dashboard/clientes/page.tsx">
export const dynamic = "force-dynamic";

import { DashboardHeader } from "@/components/dashboard-header";
import { createClient } from "@/lib/supabase/server";
import { redirect } from "next/navigation";
import Link from "next/link";
import { NovoClienteModal } from "@/components/modal/novo-cliente-modal";

export default async function ClientesPage({
  searchParams,
}: {
  searchParams: { q?: string };
}) {
  const supabase = await createClient();

  // 1. Verificação de Autenticação
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) redirect('/autenticacao/entrar');

  // 2. Termo de Busca
  const query = (await searchParams).q || "";

  // 3. Busca no Supabase
  let dbQuery = supabase
    .from('clientes')
    .select('id, nome, created_at')
    .eq('user_id', user.id)
    .order('nome', { ascending: true });

  if (query) {
    dbQuery = dbQuery.ilike('nome', `%${query}%`);
  }

  const { data: clientes } = await dbQuery;

  return (
    // CONTÊINER PAI: px-4 md:px-8 para alinhar perfeitamente com a borda externa do Header
    <div className="max-w-7xl mx-auto py-8 px-4 md:px-8">
      <DashboardHeader />
        
      {/* SUB-CONTÊINER: px-2 para alinhar o conteúdo interno com o texto interno do Header */}
      <div className="px-2">
        
        {/* BARRA DE AÇÕES E BUSCA */}
        <div className="px-8  flex flex-col md:flex-row items-center gap-4 mb-10 w-full mt-10">
          
          {/* BOTÃO QUE ABRE O MODAL (Substituindo o Link antigo) */}
          <NovoClienteModal />

          <form method="GET" className="flex-1 w-full relative">
            <input
              type="text"
              name="q"
              defaultValue={query}
              placeholder="Buscar clientes pelo nome..."
              className="w-full pl-12 pr-4 py-3.5 rounded-xl border border-zinc-800 bg-zinc-900/50 text-white focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition placeholder:text-zinc-600"
            />
            <svg className="w-5 h-5 text-zinc-500 absolute left-4 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </form>
        </div>

        {/* GRID DE CLIENTES */}
        <div className="px-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {clientes && clientes.length > 0 ? (
            clientes.map((cliente) => (
              <div 
                key={cliente.id} 
                className="group bg-zinc-900/40 border border-zinc-800 rounded-2xl p-6 hover:border-zinc-700 transition flex flex-col gap-4 min-h-[160px]"
              >
                <div className="flex items-start justify-between">
                  <div className="w-12 h-12 rounded-full bg-blue-600/10 border border-blue-500/20 flex items-center justify-center text-blue-500 group-hover:bg-blue-600/20 transition">
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                  </div>
                  <span className="text-[10px] font-mono text-zinc-600 uppercase tracking-tighter">
                    ID: {cliente.id.toString().slice(0, 8)}...
                  </span>
                </div>

                <div className="flex-1">
                  <h3 className="font-black text-xl text-white group-hover:text-blue-400 transition mb-1">
                    {cliente.nome}
                  </h3>
                  <p className="text-zinc-500 text-xs">
                    Cliente desde: {new Date(cliente.created_at).toLocaleDateString('pt-BR')}
                  </p>
                </div>

                <div className="mt-auto pt-4 border-t border-zinc-800/50 flex justify-end">
                  
                </div>
              </div>
            ))
          ) : (
            <div className="col-span-full text-center py-24 border-2 border-dashed border-zinc-800 rounded-3xl">
              <p className="text-zinc-500 font-medium">Nenhum cliente encontrado.</p>
              {query && (
                <Link href="/dashboard/clientes" className="text-blue-500 text-[10px] uppercase font-bold mt-2 inline-block hover:underline tracking-widest">
                  Limpar busca
                </Link>
              )}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="components/orcamento/historico-versoes.tsx">
'use client';

import { Database } from "@/lib/database.types";
import { useRouter, useSearchParams } from "next/navigation";
import { useTransition } from "react"; 
import { Plus } from "lucide-react";

type Versao = Database['public']['Tables']['orcamento_versoes']['Row'];

export function HistoricoVersoes({ versoes }: { versoes: Versao[] }) {
  const router = useRouter();
  const searchParams = useSearchParams();
  const [isPending, startTransition] = useTransition();

  const versaoAtivaId = searchParams.get('v') || versoes[0]?.id;

  const handleTrocarVersao = (versaoId: string) => {
    const params = new URLSearchParams(searchParams.toString());
    
    // 1. Define a versão desejada
    params.set('v', versaoId);
    
    // 2. REMOVE o modo de edição ao trocar de versão
    params.delete('edit');

    startTransition(() => {
      router.push(`?${params.toString()}`);
    });
  };

  return (
    <div className={`flex flex-wrap gap-2 mb-6 ${isPending ? 'opacity-50 pointer-events-none' : ''}`}>
      <p className="text-[10px] font-bold text-zinc-500 uppercase tracking-widest w-full mb-1">
        Histórico de Versões (Clique para visualizar)
      </p>

      {/* Botão para Criar Nova Versão (entra em modo edit) */}
      <button
        type="button"
        onClick={() => router.push(`?edit=true`)}
        className="px-3 py-1.5 rounded-lg border border-dashed border-green-600 text-green-500 hover:bg-green-600/10 transition flex items-center gap-2 text-xs font-bold"
      >
        <Plus size={14} />
        CRIAR NOVA VERSÃO
      </button>

      {/* Lista de Versões (sai do modo edit) */}
      {versoes.map((v) => {
        const isSelected = v.id === versaoAtivaId && !searchParams.get('edit');
        return (
          <button
            key={v.id}
            type="button"
            onClick={() => handleTrocarVersao(v.id)}
            className={`px-3 py-1.5 rounded-lg border transition flex items-center gap-2 ${
              isSelected
                ? "bg-blue-600 border-blue-500 text-white shadow-lg shadow-blue-900/20"
                : "bg-zinc-900 border-zinc-800 text-zinc-400 hover:border-zinc-600"
            }`}
          >
            <span className={`w-1.5 h-1.5 rounded-full ${isSelected ? "bg-white" : "bg-blue-500"}`}></span>
            <span className="text-xs font-bold font-mono">v{v.versao_numero}</span>
            <span className={`text-[9px] ${isSelected ? "text-blue-100" : "text-zinc-600"}`}>
              {new Date(v.created_at!).toLocaleDateString('pt-BR')}
            </span>
          </button>
        );
      })}
    </div>
  );
}
</file>

<file path="lib/database.types.ts">
export type Json =
  | string
  | number
  | boolean
  | null
  | { [key: string]: Json | undefined }
  | Json[]

export type Database = {
  // Allows to automatically instantiate createClient with right options
  // instead of createClient<Database, { PostgrestVersion: 'XX' }>(URL, KEY)
  __InternalSupabase: {
    PostgrestVersion: "14.1"
  }
  public: {
    Tables: {
      clientes: {
        Row: {
          created_at: string | null
          id: string
          nome: string
          user_id: string
        }
        Insert: {
          created_at?: string | null
          id?: string
          nome: string
          user_id: string
        }
        Update: {
          created_at?: string | null
          id?: string
          nome?: string
          user_id?: string
        }
        Relationships: []
      }
      insumos_acessorios: {
        Row: {
          created_at: string | null
          custo_unitario: number
          id: string
          nome: string
        }
        Insert: {
          created_at?: string | null
          custo_unitario: number
          id?: string
          nome: string
        }
        Update: {
          created_at?: string | null
          custo_unitario?: number
          id?: string
          nome?: string
        }
        Relationships: []
      }
      insumos_base: {
        Row: {
          categoria: string | null
          created_at: string | null
          id: string
          nome: string
          unidade_medida: string | null
        }
        Insert: {
          categoria?: string | null
          created_at?: string | null
          id?: string
          nome: string
          unidade_medida?: string | null
        }
        Update: {
          categoria?: string | null
          created_at?: string | null
          id?: string
          nome?: string
          unidade_medida?: string | null
        }
        Relationships: []
      }
      insumos_espiral: {
        Row: {
          capacidade_folhas: string | null
          created_at: string | null
          id: string
          preco_cento: number
          tamanho_mm: string
        }
        Insert: {
          capacidade_folhas?: string | null
          created_at?: string | null
          id?: string
          preco_cento: number
          tamanho_mm: string
        }
        Update: {
          capacidade_folhas?: string | null
          created_at?: string | null
          id?: string
          preco_cento?: number
          tamanho_mm?: string
        }
        Relationships: []
      }
      insumos_wireo: {
        Row: {
          capacidade_folhas: string | null
          created_at: string | null
          diametro: string
          id: string
          passo: string
          preco_caixa_base: number
          preco_caixa_especial: number
          quantidade_caixa: number
        }
        Insert: {
          capacidade_folhas?: string | null
          created_at?: string | null
          diametro: string
          id?: string
          passo: string
          preco_caixa_base: number
          preco_caixa_especial: number
          quantidade_caixa: number
        }
        Update: {
          capacidade_folhas?: string | null
          created_at?: string | null
          diametro?: string
          id?: string
          passo?: string
          preco_caixa_base?: number
          preco_caixa_especial?: number
          quantidade_caixa?: number
        }
        Relationships: []
      }
      orcamento_colunas: {
        Row: {
          id: string
          orcamento_id: string | null
          ordem: number | null
          quantidade: number
        }
        Insert: {
          id?: string
          orcamento_id?: string | null
          ordem?: number | null
          quantidade: number
        }
        Update: {
          id?: string
          orcamento_id?: string | null
          ordem?: number | null
          quantidade?: number
        }
        Relationships: [
          {
            foreignKeyName: "orcamento_colunas_orcamento_id_fkey"
            columns: ["orcamento_id"]
            isOneToOne: false
            referencedRelation: "orcamentos"
            referencedColumns: ["id"]
          },
        ]
      }
      orcamento_versao_valores: {
        Row: {
          id: string
          insumo_id: string
          quantidade_referencia: number | null
          valor_custo_unitario_base: number
          versao_id: string
        }
        Insert: {
          id?: string
          insumo_id: string
          quantidade_referencia?: number | null
          valor_custo_unitario_base: number
          versao_id: string
        }
        Update: {
          id?: string
          insumo_id?: string
          quantidade_referencia?: number | null
          valor_custo_unitario_base?: number
          versao_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "orcamento_versao_valores_insumo_id_fkey"
            columns: ["insumo_id"]
            isOneToOne: false
            referencedRelation: "insumos_base"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "orcamento_versao_valores_versao_id_fkey"
            columns: ["versao_id"]
            isOneToOne: false
            referencedRelation: "orcamento_versoes"
            referencedColumns: ["id"]
          },
        ]
      }
      orcamento_versoes: {
        Row: {
          created_at: string | null
          custo_total_calculado: number | null
          descricao_alteracao: string | null
          id: string
          orcamento_id: string
          versao_numero: number
        }
        Insert: {
          created_at?: string | null
          custo_total_calculado?: number | null
          descricao_alteracao?: string | null
          id?: string
          orcamento_id: string
          versao_numero: number
        }
        Update: {
          created_at?: string | null
          custo_total_calculado?: number | null
          descricao_alteracao?: string | null
          id?: string
          orcamento_id?: string
          versao_numero?: number
        }
        Relationships: [
          {
            foreignKeyName: "orcamento_versoes_orcamento_id_fkey"
            columns: ["orcamento_id"]
            isOneToOne: false
            referencedRelation: "orcamentos"
            referencedColumns: ["id"]
          },
        ]
      }
      orcamentos: {
        Row: {
          cliente_id: string
          created_at: string | null
          id: string
          titulo: string
          user_id: string
        }
        Insert: {
          cliente_id: string
          created_at?: string | null
          id?: string
          titulo: string
          user_id: string
        }
        Update: {
          cliente_id?: string
          created_at?: string | null
          id?: string
          titulo?: string
          user_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "orcamentos_cliente_id_fkey"
            columns: ["cliente_id"]
            isOneToOne: false
            referencedRelation: "clientes"
            referencedColumns: ["id"]
          },
        ]
      }
      tipos_papel: {
        Row: {
          created_at: string | null
          f1: number | null
          f2: number | null
          f3: number | null
          f4: number | null
          f6: number | null
          f8: number | null
          f9: number | null
          id: string
          nome: string
        }
        Insert: {
          created_at?: string | null
          f1?: number | null
          f2?: number | null
          f3?: number | null
          f4?: number | null
          f6?: number | null
          f8?: number | null
          f9?: number | null
          id?: string
          nome: string
        }
        Update: {
          created_at?: string | null
          f1?: number | null
          f2?: number | null
          f3?: number | null
          f4?: number | null
          f6?: number | null
          f8?: number | null
          f9?: number | null
          id?: string
          nome?: string
        }
        Relationships: []
      }
    }
    Views: {
      [_ in never]: never
    }
    Functions: {
      [_ in never]: never
    }
    Enums: {
      [_ in never]: never
    }
    CompositeTypes: {
      [_ in never]: never
    }
  }
}

type DatabaseWithoutInternals = Omit<Database, "__InternalSupabase">

type DefaultSchema = DatabaseWithoutInternals[Extract<keyof Database, "public">]

export type Tables<
  DefaultSchemaTableNameOrOptions extends
    | keyof (DefaultSchema["Tables"] & DefaultSchema["Views"])
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof (DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"] &
        DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Views"])
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? (DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"] &
      DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Views"])[TableName] extends {
      Row: infer R
    }
    ? R
    : never
  : DefaultSchemaTableNameOrOptions extends keyof (DefaultSchema["Tables"] &
        DefaultSchema["Views"])
    ? (DefaultSchema["Tables"] &
        DefaultSchema["Views"])[DefaultSchemaTableNameOrOptions] extends {
        Row: infer R
      }
      ? R
      : never
    : never

export type TablesInsert<
  DefaultSchemaTableNameOrOptions extends
    | keyof DefaultSchema["Tables"]
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"]
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"][TableName] extends {
      Insert: infer I
    }
    ? I
    : never
  : DefaultSchemaTableNameOrOptions extends keyof DefaultSchema["Tables"]
    ? DefaultSchema["Tables"][DefaultSchemaTableNameOrOptions] extends {
        Insert: infer I
      }
      ? I
      : never
    : never

export type TablesUpdate<
  DefaultSchemaTableNameOrOptions extends
    | keyof DefaultSchema["Tables"]
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"]
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"][TableName] extends {
      Update: infer U
    }
    ? U
    : never
  : DefaultSchemaTableNameOrOptions extends keyof DefaultSchema["Tables"]
    ? DefaultSchema["Tables"][DefaultSchemaTableNameOrOptions] extends {
        Update: infer U
      }
      ? U
      : never
    : never

export type Enums<
  DefaultSchemaEnumNameOrOptions extends
    | keyof DefaultSchema["Enums"]
    | { schema: keyof DatabaseWithoutInternals },
  EnumName extends DefaultSchemaEnumNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaEnumNameOrOptions["schema"]]["Enums"]
    : never = never,
> = DefaultSchemaEnumNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaEnumNameOrOptions["schema"]]["Enums"][EnumName]
  : DefaultSchemaEnumNameOrOptions extends keyof DefaultSchema["Enums"]
    ? DefaultSchema["Enums"][DefaultSchemaEnumNameOrOptions]
    : never

export type CompositeTypes<
  PublicCompositeTypeNameOrOptions extends
    | keyof DefaultSchema["CompositeTypes"]
    | { schema: keyof DatabaseWithoutInternals },
  CompositeTypeName extends PublicCompositeTypeNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[PublicCompositeTypeNameOrOptions["schema"]]["CompositeTypes"]
    : never = never,
> = PublicCompositeTypeNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[PublicCompositeTypeNameOrOptions["schema"]]["CompositeTypes"][CompositeTypeName]
  : PublicCompositeTypeNameOrOptions extends keyof DefaultSchema["CompositeTypes"]
    ? DefaultSchema["CompositeTypes"][PublicCompositeTypeNameOrOptions]
    : never

export const Constants = {
  public: {
    Enums: {},
  },
} as const
</file>

<file path="package.json">
{
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint ."
  },
  "dependencies": {
    "@hookform/resolvers": "^5.2.2",
    "@radix-ui/react-checkbox": "^1.3.1",
    "@radix-ui/react-dialog": "^1.1.15",
    "@radix-ui/react-dropdown-menu": "^2.1.14",
    "@radix-ui/react-label": "^2.1.6",
    "@radix-ui/react-slot": "^1.2.2",
    "@supabase/ssr": "latest",
    "@supabase/supabase-js": "latest",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "framer-motion": "^12.29.2",
    "lucide-react": "^0.511.0",
    "next": "latest",
    "next-themes": "^0.4.6",
    "nextjs-toploader": "^3.9.17",
    "react": "^19.0.0",
    "react-dom": "^19.0.0",
    "react-hook-form": "^7.71.1",
    "supabase": "^2.72.8",
    "tailwind-merge": "^3.3.0",
    "zod": "^4.3.6"
  },
  "devDependencies": {
    "@eslint/eslintrc": "^3",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "autoprefixer": "^10.4.20",
    "eslint": "^9",
    "eslint-config-next": "15.3.1",
    "postcss": "^8",
    "tailwindcss": "^3.4.1",
    "tailwindcss-animate": "^1.0.7",
    "typescript": "^5"
  }
}
</file>

<file path="app/dashboard/orcamentos/page.tsx">
export const dynamic = "force-dynamic";

import { DashboardHeader } from "@/components/dashboard-header";
import Link from "next/link";
import { createClient } from "@/lib/supabase/server";
import { redirect } from "next/navigation";

export default async function DashboardOrcamentosPage({
  searchParams,
}: {
  searchParams: { q?: string };
}) {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) redirect('/autenticacao/entrar');

  const query = (await searchParams).q || "";

  const { data: clientes } = await supabase.from('clientes').select('id, nome');
  const clientesMap = new Map((clientes || []).map(c => [c.id, c.nome]));
  
  const idsClientesFiltrados = (clientes || [])
    .filter(c => c.nome.toLowerCase().includes(query.toLowerCase()))
    .map(c => c.id);

  let orcamentosQuery = supabase
    .from('orcamentos')
    .select('id, titulo, cliente_id, created_at')
    .eq('user_id', user.id)
    .order('created_at', { ascending: false });

  if (query) {
    const filterParts = [`titulo.ilike.%${query}%`];
    if (idsClientesFiltrados.length > 0) {
      filterParts.push(`cliente_id.in.(${idsClientesFiltrados.join(',')})`);
    }
    orcamentosQuery = orcamentosQuery.or(filterParts.join(','));
  }

  const { data: orcamentos } = await orcamentosQuery;

  return (
    <div className="max-w-7xl mx-auto py-8 px-4 md:px-8">
      <DashboardHeader />
        
        {/* Barra de Busca */}
        <div className="px-8 flex flex-col md:flex-row items-center gap-4 mb-10 w-full">
          <Link href="/dashboard/orcamentos/novo" className="w-full md:w-auto">
            <button className="w-full md:w-auto bg-blue-600 text-white font-bold px-6 py-3.5 rounded-xl shadow-lg shadow-blue-900/20 hover:bg-blue-500 transition uppercase text-xs flex items-center justify-center gap-2">
               <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4" /></svg>
               Novo Orçamento
            </button>
          </Link>

          <form method="GET" className="flex-1 w-full relative">
            <input
              type="text"
              name="q"
              defaultValue={query}
              placeholder="Buscar por título ou nome do cliente..."
              className="w-full pl-12 pr-4 py-3.5 rounded-xl border border-zinc-800 bg-zinc-900/50 text-white focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition"
            />
            <svg className="w-5 h-5 text-zinc-500 absolute left-4 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </form>
        </div>

        {/* Grid de Cards */}
        <div className="px-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {(orcamentos || []).map((orc) => (
            /* O Link agora envolve todo o Card */
            <Link 
              key={orc.id} 
              href={`/dashboard/orcamentos/${orc.id}?edit=true`}
              className="group bg-zinc-900/40 border border-zinc-800 rounded-2xl p-6 hover:border-blue-500/50 hover:bg-zinc-800/60 transition-all flex flex-col gap-4 cursor-pointer"
            >
              <div className="flex-1">
                <div className="font-black text-xl text-white group-hover:text-blue-400 transition mb-1 line-clamp-2">
                  {orc.titulo}
                </div>
                <div className="text-zinc-400 text-sm flex items-center gap-2">
                  <span className="w-1.5 h-1.5 rounded-full bg-zinc-700 group-hover:bg-blue-500 transition"></span>
                  Cliente: <span className="text-zinc-200">{clientesMap.get(orc.cliente_id) || "Desconhecido"}</span>
                </div>
              </div>

              <div className="flex justify-between items-center mt-auto pt-4 border-t border-zinc-800/50">
                <span className="text-[10px] font-bold text-zinc-500 uppercase tracking-widest">
                  {orc.created_at ? new Date(orc.created_at).toLocaleDateString('pt-BR') : '-'}
                </span>
                
                {/* O botão agora é visual, já que o Link pai cuida do clique */}
                <div className="px-4 py-2 rounded-lg bg-zinc-800 text-white text-[10px] font-bold uppercase group-hover:bg-blue-600 transition">
                  Editar Orçamento
                </div>
              </div>
            </Link>
          ))}
        </div>
    </div>
  );
}
</file>

<file path="app/layout.tsx">
import type { Metadata } from "next";


import "./globals.css";
import NextTopLoader from "nextjs-toploader";

export const metadata: Metadata = {
  metadataBase: new URL("https://precifica.nkwflow.com"),
  title: "Precifica - Simplificando seus orçamentos",
  description: "Facilite a criação e gestão de orçamentos com nossa ferramenta intuitiva e eficiente.",
  icons: {
    icon: "/icon.svg",
  },
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="pt-BR" className="dark">
      <body className="font-sans antialiased bg-background text-foreground">

        <NextTopLoader
          color="#2563eb" // Cor azul-600 (a mesma dos seus botões)
          initialPosition={0.08}
          crawlSpeed={200}
          height={3}
          crawl={true}
          showSpinner={false} // Desative o spinner se quiser apenas a barra
          easing="ease"
          speed={200}
          shadow="0 0 10px #2563eb,0 0 5px #2563eb"
        />

        {children}
      </body>
    </html>
  );
}
</file>

<file path="app/dashboard/orcamentos/actions/salvarFluxoOrcamento.ts">
"use server";

import { revalidatePath } from "next/cache";
import { createClient } from "@/lib/supabase/server";
import { Database } from "@/lib/database.types";
import { redirect } from "next/navigation"; // 1. Importar o redirect

type VersaoInsert = Database['public']['Tables']['orcamento_versoes']['Insert'];

interface FluxoOrcamentoPayload {
  orcamentoId?: string;
  clienteId: string;
  titulo: string;
  userId: string;
  markup: number;
  quantidadesVisiveis: number[];
  valores: Array<{
    insumo_id: string;
    quantidade_referencia: number;
    valor_custo_unitario_base: number;
  }>;
}

export async function salvarFluxoOrcamento(payload: FluxoOrcamentoPayload) {
  const supabase = await createClient();
  let orcamentoId = payload.orcamentoId;

  // 1. Criar Orçamento Base
  if (!orcamentoId) {
    const { data: orcamento, error: orcError } = await supabase
      .from("orcamentos")
      .insert({
        cliente_id: payload.clienteId,
        titulo: payload.titulo,
        user_id: payload.userId,
      })
      .select().single();

    if (orcError || !orcamento) throw new Error("Erro ao criar orçamento");
    orcamentoId = orcamento.id;
  }

  // 2. Incrementar número da versão
  const { data: versoes } = await supabase
    .from("orcamento_versoes")
    .select("versao_numero")
    .eq("orcamento_id", orcamentoId)
    .order("versao_numero", { ascending: false })
    .limit(1);

  const nextVersao = (versoes?.[0]?.versao_numero || 0) + 1;

  // 3. Criar a Versão
  const { data: versao, error: vError } = await supabase
    .from("orcamento_versoes")
    .insert({
      orcamento_id: orcamentoId,
      versao_numero: nextVersao,
      descricao_alteracao: `Cálculo gerado em ${new Date().toLocaleString('pt-BR')}`,
    } as VersaoInsert)
    .select().single();

  if (vError || !versao) throw new Error("Erro ao criar versão");

  if (!payload.valores || !Array.isArray(payload.valores)) {
    throw new Error("Os valores da grade são obrigatórios.");
  }

  // 4. Salvar Valores
  const valoresInsert = payload.valores.map((v) => ({
    versao_id: versao.id,
    insumo_id: v.insumo_id,
    valor_custo_unitario_base: v.valor_custo_unitario_base,
    quantidade_referencia: v.quantidade_referencia 
  }));

  const { error: valError } = await supabase
    .from("orcamento_versao_valores")
    .insert(valoresInsert);

  if (valError) throw new Error(`Erro ao salvar valores: ${valError.message}`);

  // 5. Atualizar as Colunas do Orçamento
  const quantidadesUnicas = payload.quantidadesVisiveis;

  await supabase.from("orcamento_colunas").delete().eq("orcamento_id", orcamentoId);
  
  const { error: colError } = await supabase.from("orcamento_colunas").insert(
    quantidadesUnicas.map((qtd, index) => ({
      orcamento_id: orcamentoId,
      quantidade: qtd,
      ordem: index
    }))
  );

  if (colError) throw new Error(`Erro ao atualizar colunas: ${colError.message}`);

  // 6. Revalidar e Redirecionar
  revalidatePath(`/dashboard/orcamentos/${orcamentoId}`);
  
  // Redireciona para o orçamento com o ID da versão recém criada no parâmetro 'v'
  // Note que NÃO passamos 'edit=true' para que ele caia em modo de visualização
  redirect(`/dashboard/orcamentos/${orcamentoId}?v=${versao.id}`);
}
</file>

<file path="app/page.tsx">
import { redirect } from "next/navigation";
import { createClient } from "@/lib/supabase/server";

export default async function Home() {
  const supabase = await createClient();
  const { data } = await supabase.auth.getClaims();
  if (data?.claims) {
    redirect("/dashboard/orcamentos");
  }
  redirect("/autenticacao/entrar");
}
</file>

<file path="components/orcamento/grade-orcamento.tsx">
'use client';

import React, { useState, useMemo, useEffect } from 'react';
import { Calculator, X, ChevronDown, ChevronRight, Plus, Trash2, Search, Settings2 } from 'lucide-react';

interface Insumo {
  id: string;
  nome: string;
  categoria: string;
  custo_unitario: number;
}

interface TipoPapel {
  id: string;
  nome: string;
  f1: number; f2: number; f3: number; f4: number; f6: number; f8: number; f9: number;
}

interface InsumoWireo {
  id: string;
  diametro: string;
  passo: string;
  quantidade_caixa: number;
  preco_caixa_base: number;
  preco_caixa_especial: number;
}

interface InsumoEspiral {
  id: string;
  tamanho_mm: string;
  preco_cento: number;
}

interface InsumoAcessorio {
  id: string;
  nome: string;
  custo_unitario: number;
}

interface GradeOrcamentoProps {
  insumosIniciais: Insumo[];
  quantidadesPadrao: number[];
  markupInicial: number;
  tiposPapel: TipoPapel[];
  wireoOptions: InsumoWireo[];
  espiralOptions: InsumoEspiral[];
  acessoriosOptions: InsumoAcessorio[];
  readOnly?: boolean; // NOVO: Propriedade para travar edição
}

export function GradeOrcamento({
  insumosIniciais,
  quantidadesPadrao,
  markupInicial,
  tiposPapel,
  wireoOptions,
  espiralOptions,
  acessoriosOptions,
  readOnly = false // Default falso para manter retrocompatibilidade
}: GradeOrcamentoProps) {
  const [quantidades, setQuantidades] = useState<number[]>(quantidadesPadrao);

  const [markup, setMarkup] = useState<number>(markupInicial);
  const [custos, setCustos] = useState<Record<string, number>>({});
  const [expandedCategories, setExpandedCategories] = useState<Record<string, boolean>>({});

  // Estados dos Modais
  const [modalPapel, setModalPapel] = useState({ isOpen: false, insumoId: '' });
  const [modalEncadernacao, setModalEncadernacao] = useState({ 
    isOpen: false, 
    insumoId: '', 
    tipo: '' as 'wireo' | 'espiral' 
  });
  const [modalAcessorio, setModalAcessorio] = useState({ isOpen: false, insumoId: '', selectedId: '', quantidade: 1 });

  // Estados de Cálculo
  const [calcPapel, setCalcPapel] = useState({ papelId: '', formato: 'f4' as keyof TipoPapel, qtdFolhas: 1 });
  const [calcEncadernacao, setCalcEncadernacao] = useState({ selectedId: '', corEspecial: false, quantidade: 1 });

  const [isModalOpen, setIsModalOpen] = useState(false);
  const [activeInsumoId, setActiveInsumoId] = useState<string | null>(null);

  const [calcParams, setCalcParams] = useState({
    papelId: '',
    formato: 'f1' as keyof Omit<TipoPapel, 'id' | 'nome'>,
    quantidadeFolhas: 1
  });


  // Sincroniza quantidades se as quantidadesPadrao mudarem (ao trocar de versão no histórico)
  useEffect(() => {
    setQuantidades(quantidadesPadrao);
  }, [quantidadesPadrao]);

  // Removido papeisFiltrados pois não estava sendo utilizado

  useEffect(() => {
    const initCustos: Record<string, number> = {};
    const initExpanded: Record<string, boolean> = {};
    const categoriasPrincipais = ['miolo', 'capa', 'guardas'];

    insumosIniciais.forEach((i) => {
      initCustos[i.id] = i.custo_unitario || 0;
      const cat = (i.categoria || 'outros').toLowerCase();
      if (!initExpanded.hasOwnProperty(cat)) {
        initExpanded[cat] = categoriasPrincipais.includes(cat);
      }
    });

    setCustos(initCustos);
    setExpandedCategories(initExpanded);
  }, [insumosIniciais, wireoOptions, espiralOptions]);

  // DENTRO DE grade-orcamento.tsx

  useEffect(() => {
    if (readOnly) return;

    // MAPEAMENTO CORRETO: 
    // Para cada insumo que tem custo, criamos uma entrada para CADA quantidade da grade
    const valoresExport = insumosIniciais
      .filter(insumo => (custos[insumo.id] || 0) > 0)
      .flatMap(insumo =>
        quantidades.map(qtd => ({
          insumo_id: insumo.id,
          quantidade_referencia: qtd, // Agora usa a quantidade real da coluna
          valor_custo_unitario_base: custos[insumo.id]
        }))
      );

    const hiddenInput = document.getElementById('grade-dados-input') as HTMLInputElement;
    if (hiddenInput) {
      hiddenInput.value = JSON.stringify({
        markup: markup,
        valores: valoresExport,
        quantidadesVisiveis: quantidades
      });
    }
  }, [insumosIniciais, custos, markup, quantidades, readOnly]);

  const [searchTerm, setSearchTerm] = useState('');

  const papeisFiltrados = useMemo(() => {
    if (searchTerm.length < 4) return [];
    return tiposPapel.filter(p =>
      p.nome.toLowerCase().includes(searchTerm.toLowerCase())
    );
  }, [searchTerm, tiposPapel]);

  const adicionarColuna = () => {
    if (readOnly) return;
    const ultimaQtd = quantidades[quantidades.length - 1] || 0;
    setQuantidades([...quantidades, ultimaQtd + 100]);
  };

  const removerColuna = (index: number) => {
    if (readOnly) return;
    if (quantidades.length > 1) {
      setQuantidades(quantidades.filter((_, i) => i !== index));
    }
  };

  const alterarQuantidade = (index: number, valor: number) => {
    if (readOnly) return;
    const novas = [...quantidades];
    novas[index] = valor;
    setQuantidades(novas);
  };

  const categoriasOrdenadas = useMemo(() => {
    const ordemCategorias = ['miolo', 'capa', 'guardas', 'bloco 1° via', 'bloco 2° via', 'bloco 3° via', 'papelão', 'outros', 'tercerizados'];
    const groups: Record<string, Insumo[]> = {};

    insumosIniciais.forEach((i) => {
      const cat = (i.categoria || 'outros').toLowerCase();
      if (!groups[cat]) groups[cat] = [];
      groups[cat].push(i);
    });

    return Object.entries(groups)
      .sort(([a], [b]) => {
        const indexA = ordemCategorias.indexOf(a);
        const indexB = ordemCategorias.indexOf(b);
        return (indexA === -1 ? 999 : indexA) - (indexB === -1 ? 999 : indexB);
      })
      .map(([cat, items]) => {
        const itemsOrdenados = [...items].sort((a, b) => {
          const aIsPapel = a.nome.toLowerCase().includes('papel') && !a.nome.toLowerCase().includes('papelão');
          const bIsPapel = b.nome.toLowerCase().includes('papel') && !b.nome.toLowerCase().includes('papelão');
          if (aIsPapel && !bIsPapel) return -1;
          if (!aIsPapel && bIsPapel) return 1;
          return 0;
        });
        return [cat, itemsOrdenados] as [string, Insumo[]];
      });
  }, [insumosIniciais]);

  const aplicarCalculoPapel = () => {
    const papelSelecionado = tiposPapel.find(p => p.id === calcParams.papelId);
    if (papelSelecionado && activeInsumoId) {
      const valorUnitarioFormato = papelSelecionado[calcParams.formato] || 0;
      const custoTotalFinal = valorUnitarioFormato * calcParams.quantidadeFolhas;
      setCustos(prev => ({ ...prev, [activeInsumoId]: Number(custoTotalFinal.toFixed(4)) }));
      setIsModalOpen(false);
    }
  };

  const totaisCusto = useMemo(() => {
    return quantidades.map(q =>
      insumosIniciais.reduce((acc, insumo) => acc + ((custos[insumo.id] || 0) / 100) * q, 0)
    );
  }, [custos, quantidades, insumosIniciais]);

  // --- LÓGICA DE CÁLCULO ENCADERNAÇÃO ---
  const aplicarCalculoEncadernacao = () => {
    let custoUnitario = 0;
    if (modalEncadernacao.tipo === 'wireo') {
      const item = wireoOptions.find(w => w.id === calcEncadernacao.selectedId);
      if (item) {
        const precoCaixa = calcEncadernacao.corEspecial ? item.preco_caixa_especial : item.preco_caixa_base;
        custoUnitario = precoCaixa / item.quantidade_caixa;
      }
    } else {
      const item = espiralOptions.find(e => e.id === calcEncadernacao.selectedId);
      if (item) custoUnitario = item.preco_cento / 100;
    }
    const quantidade = calcEncadernacao.quantidade > 0 ? calcEncadernacao.quantidade : 1;
    const custoTotal = custoUnitario * quantidade;
    setCustos(prev => ({ ...prev, [modalEncadernacao.insumoId]: Number(custoTotal.toFixed(4)) }));
    setModalEncadernacao({ isOpen: false, insumoId: '', tipo: '' as any });
    setCalcEncadernacao({ selectedId: '', corEspecial: false, quantidade: 1 });
  };

  // Lógica do modal de acessório
  const aplicarCalculoAcessorio = () => {
    const acessorio = acessoriosOptions.find(a => a.id === modalAcessorio.selectedId);
    const quantidade = modalAcessorio.quantidade > 0 ? modalAcessorio.quantidade : 1;
    if (acessorio && modalAcessorio.insumoId) {
      const custoTotal = acessorio.custo_unitario * quantidade;
      setCustos(prev => ({ ...prev, [modalAcessorio.insumoId]: Number(custoTotal.toFixed(4)) }));
    }
    setModalAcessorio({ isOpen: false, insumoId: '', selectedId: '', quantidade: 1 });
  };

  return (
    <div>
      <input type="hidden" name="grade_dados" id="grade-dados-input" />

      <div className="flex justify-between items-center bg-zinc-900/40 p-4 rounded-xl border border-zinc-800">
        <div className="flex items-center gap-4">
          <label className="text-xs font-bold text-zinc-500 uppercase tracking-widest">Markup (%)</label>
          <input
            type="number"
            value={markup}
            disabled={readOnly}
            onChange={(e) => setMarkup(Number(e.target.value))}
            className="bg-zinc-950 border border-zinc-700 rounded px-3 py-1 w-20 text-blue-400 font-bold outline-none focus:border-blue-500 transition disabled:opacity-50"
          />
        </div>
        {!readOnly && (
          <button
            type="button"
            onClick={adicionarColuna}
            className="flex items-center gap-2 bg-blue-600/10 text-blue-500 hover:bg-blue-600/20 px-4 py-2 rounded-lg text-xs font-bold transition uppercase tracking-tighter"
          >
            <Plus size={14} /> Adicionar Coluna
          </button>
        )}
      </div>

      <div className="mt-8 overflow-x-auto rounded-xl border border-zinc-800 bg-zinc-950/50 shadow-xl">
        <table className="w-full text-left text-sm border-collapse min-w-[800px]">
          <thead className="bg-zinc-900 text-zinc-500 uppercase font-bold">
            <tr>
              <th className="p-4 w-1/4 border-b border-zinc-800 text-[10px]">Insumo</th>
              <th className="p-4 text-center w-40 border-b border-zinc-800 text-[10px]">Custo Base (100un)</th>
              {quantidades.map((q, i) => (
                <th key={i} className="p-4 text-center bg-zinc-800/10 border-b border-zinc-800 min-w-[130px]">
                  <div className="flex flex-col items-center justify-center group">
                    <input
                      type="number"
                      value={q}
                      disabled={readOnly}
                      onChange={(e) => alterarQuantidade(i, Number(e.target.value))}
                      className="bg-transparent border-none text-center text-blue-400 font-black text-lg w-full focus:ring-0 focus:outline-none p-0 leading-none disabled:cursor-default"
                    />
                    <span className="text-[9px] text-zinc-500 mt-1 tracking-tighter">UNIDADES</span>
                    {!readOnly && (
                      <button
                        type="button"
                        onClick={() => removerColuna(i)}
                        className="opacity-0 group-hover:opacity-100 text-red-500/50 hover:text-red-500 transition-all mt-1"
                      >
                        <Trash2 size={12} />
                      </button>
                    )}
                  </div>
                </th>
              ))}
            </tr>
          </thead>
          <tbody className="divide-y divide-zinc-800/50">
            {categoriasOrdenadas.map(([cat, items]) => {
              const isExpanded = expandedCategories[cat];
              return (
                <React.Fragment key={cat}>
                  <tr onClick={() => setExpandedCategories(p => ({ ...p, [cat]: !isExpanded }))} className="bg-zinc-800/30 cursor-pointer hover:bg-zinc-800/50">
                    <td colSpan={2 + quantidades.length} className="px-4 py-2 border-y border-zinc-800">
                      <div className="flex items-center gap-2 text-[10px] font-black text-blue-400 uppercase tracking-widest">
                        {isExpanded ? <ChevronDown size={14} /> : <ChevronRight size={14} />} {cat}
                      </div>
                    </td>
                  </tr>
                  {isExpanded && items.map(item => {
                    const isPapel = item.nome.toLowerCase().includes('papel') && !item.nome.toLowerCase().includes('papelão');
                    const isWireo = item.nome.toLowerCase().includes('wire-o');
                    const isEspiral = item.nome.toLowerCase().includes('espiral');
                    const isAcessorio = ['acessório 1', 'acessório 2', 'acessório 3'].includes(item.nome.trim().toLowerCase());

                    return (
                      <tr key={item.id} className="hover:bg-zinc-800/10 transition group">
                        <td className="p-4 text-zinc-300 font-medium">{item.nome}</td>
                        <td className="p-4">
                          <div className="relative flex items-center gap-2">
                            <div className="relative flex-1">
                              <span className="absolute left-2 top-1.5 text-zinc-600 text-[10px]">R$</span>
                              <input
                                type="number"
                                step="0.0001"
                                disabled={readOnly}
                                value={custos[item.id] ?? 0}
                                onChange={(e) => setCustos({ ...custos, [item.id]: Number(e.target.value) })}
                                className="w-full bg-zinc-950 border border-zinc-800 rounded px-2 py-1.5 pl-7 text-right tabular-nums text-zinc-400 focus:text-blue-400 outline-none disabled:opacity-50"
                              />
                            </div>
                            {!readOnly && (isPapel || isWireo || isEspiral || isAcessorio) && (
                              <button
                                type="button"
                                onClick={() => {
                                  if (isPapel) {
                                    setIsModalOpen(true);
                                    setActiveInsumoId(item.id);
                                  } else if (isWireo || isEspiral) {
                                    setModalEncadernacao({ 
                                      isOpen: true, 
                                      insumoId: item.id, 
                                      tipo: isWireo ? 'wireo' : 'espiral' 
                                    });
                                  } else if (isAcessorio) {
                                    setModalAcessorio({ isOpen: true, insumoId: item.id, selectedId: '', quantidade: 1 });
                                  }
                                }}
                                className="p-1.5 bg-blue-600/10 text-blue-400 rounded-md hover:bg-blue-600 hover:text-white transition-all"
                              >
                                <Calculator size={14} />
                              </button>
                            )}
                                {/* MODAL ACESSÓRIO */}
                                {modalAcessorio.isOpen && (
                                  <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                                    <div className="bg-zinc-900 border border-zinc-800 p-6 rounded-2xl w-full max-w-md shadow-2xl">
                                      <div className="flex justify-between items-center mb-6">
                                        <h3 className="text-white font-bold flex items-center gap-2 uppercase tracking-wider text-sm">
                                          <Settings2 className="text-blue-500" size={18} />
                                          Calc. Acessório
                                        </h3>
                                        <button onClick={() => setModalAcessorio({ ...modalAcessorio, isOpen: false })} className="text-zinc-500 hover:text-white">
                                          <X size={20} />
                                        </button>
                                      </div>
                                      <div className="space-y-4">
                                        <div>
                                          <label className="text-[10px] font-bold text-zinc-500 uppercase mb-1.5 block">Selecione o Acessório</label>
                                          <select
                                            className="w-full bg-zinc-950 border border-zinc-800 rounded-xl p-3 text-sm text-white outline-none"
                                            value={modalAcessorio.selectedId}
                                            onChange={e => setModalAcessorio({ ...modalAcessorio, selectedId: e.target.value })}
                                          >
                                            <option value="">Selecione...</option>
                                            {(acessoriosOptions || []).map(a => (
                                              <option key={a.id} value={a.id}>{a.nome} - R$ {a.custo_unitario.toLocaleString('pt-BR', { minimumFractionDigits: 4 })}</option>
                                            ))}
                                          </select>
                                        </div>
                                        <div>
                                          <label className="text-[10px] font-bold text-zinc-500 uppercase mb-1.5 block">Quantidade</label>
                                          <input
                                            type="number"
                                            min={1}
                                            className="w-full bg-zinc-950 border border-zinc-800 rounded-xl p-3 text-sm text-white outline-none"
                                            value={modalAcessorio.quantidade}
                                            onChange={e => setModalAcessorio({ ...modalAcessorio, quantidade: Number(e.target.value) })}
                                          />
                                        </div>
                                        <div className="bg-blue-600/5 border border-blue-500/20 p-4 rounded-xl mt-2 space-y-2">
                                          <div className="flex justify-between text-[11px] text-zinc-400">
                                            <span>Valor unitário:</span>
                                            <span className="text-zinc-300">
                                              {(() => {
                                                const acessorio = acessoriosOptions.find(a => a.id === modalAcessorio.selectedId);
                                                return acessorio ? `R$ ${acessorio.custo_unitario.toLocaleString('pt-BR', { minimumFractionDigits: 4 })}` : 'R$ 0,0000';
                                              })()}
                                            </span>
                                          </div>
                                          <div className="flex justify-between text-[11px] text-zinc-400">
                                            <span>Quantidade:</span>
                                            <span className="text-zinc-300">{modalAcessorio.quantidade}</span>
                                          </div>
                                          <div className="flex justify-between text-sm font-bold text-white border-t border-zinc-800 pt-2">
                                            <span>Custo Total:</span>
                                            <span className="text-blue-400">
                                              {(() => {
                                                const acessorio = acessoriosOptions.find(a => a.id === modalAcessorio.selectedId);
                                                const quantidade = modalAcessorio.quantidade > 0 ? modalAcessorio.quantidade : 1;
                                                return acessorio ? (acessorio.custo_unitario * quantidade).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : 'R$ 0,00';
                                              })()}
                                            </span>
                                          </div>
                                        </div>
                                        <button
                                          type="button"
                                          onClick={aplicarCalculoAcessorio}
                                          disabled={!modalAcessorio.selectedId}
                                          className="w-full bg-blue-600 hover:bg-blue-700 disabled:opacity-50 text-white font-bold py-3 rounded-xl transition-all mt-4"
                                        >
                                          APLICAR VALOR
                                        </button>
                                      </div>
                                    </div>
                                  </div>
                                )}
                          </div>
                        </td>
                        {quantidades.map((q, i) => (
                          <td key={i} className="p-4 text-center text-zinc-500 tabular-nums border-l border-zinc-800/30 font-mono">
                            {(((custos[item.id] || 0) / 100) * q).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                          </td>
                        ))}
                      </tr>
                    );
                  })}
                </React.Fragment>
              );
            })}
          </tbody>
          <tfoot className="bg-zinc-900/50 border-t-2 border-zinc-800">
            <tr className="bg-zinc-900/80">
              <td className="p-4 font-bold text-zinc-400 uppercase text-[10px]">Custo Total</td>
              <td className="p-4"></td>
              {totaisCusto.map((total, i) => (
                <td key={i} className="p-4 text-center text-zinc-300 font-mono font-bold border-l border-zinc-800/30">
                  {total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}
                </td>
              ))}
            </tr>
            <tr className="bg-blue-600/10">
              <td className="p-4 font-black text-blue-500 uppercase text-[10px]">Venda ({markup}%)</td>
              <td className="p-4"></td>
              {totaisCusto.map((total, i) => (
                <td key={i} className="p-4 text-center text-blue-400 font-mono font-black text-lg border-l border-zinc-800/30">
                  {(total * (1 + markup / 100)).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}
                </td>
              ))}
            </tr>
          </tfoot>
        </table>
      </div>

      {/* MODAL ENCADERNAÇÃO (Wire-o / Espiral) */}
      {modalEncadernacao.isOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
          <div className="bg-zinc-900 border border-zinc-800 p-6 rounded-2xl w-full max-w-md shadow-2xl">
            <div className="flex justify-between items-center mb-6">
              <h3 className="text-white font-bold flex items-center gap-2 uppercase tracking-wider text-sm">
                <Settings2 className="text-blue-500" size={18} />
                Calc. {modalEncadernacao.tipo === 'wireo' ? 'Wire-o' : 'Espiral'}
              </h3>
              <button onClick={() => setModalEncadernacao({ ...modalEncadernacao, isOpen: false })} className="text-zinc-500 hover:text-white">
                <X size={20} />
              </button>
            </div>

            <div className="space-y-4">
              <div>
                <label className="text-[10px] font-bold text-zinc-500 uppercase mb-1.5 block">Selecione o Diâmetro / Tamanho</label>
                <select 
                  className="w-full bg-zinc-950 border border-zinc-800 rounded-xl p-3 text-sm text-white outline-none"
                  value={calcEncadernacao.selectedId}
                  onChange={(e) => setCalcEncadernacao({ ...calcEncadernacao, selectedId: e.target.value })}
                >
                  <option value="">Selecione...</option>
                  {modalEncadernacao.tipo === 'wireo' 
                    ? (wireoOptions || []).map(w => <option key={w.id} value={w.id}>{w.diametro} ({w.passo}) - {w.quantidade_caixa}un</option>)
                    : (espiralOptions || []).map(e => <option key={e.id} value={e.id}>{e.tamanho_mm}</option>)
                  }
                </select>
              </div>
              <div>
                <label className="text-[10px] font-bold text-zinc-500 uppercase mb-1.5 block">Quantidade</label>
                <input
                  type="number"
                  min={1}
                  className="w-full bg-zinc-950 border border-zinc-800 rounded-xl p-3 text-sm text-white outline-none"
                  value={calcEncadernacao.quantidade}
                  onChange={e => setCalcEncadernacao({ ...calcEncadernacao, quantidade: Number(e.target.value) })}
                />
              </div>
              <div className="bg-blue-600/5 border border-blue-500/20 p-4 rounded-xl mt-2 space-y-2">
                <div className="flex justify-between text-[11px] text-zinc-400">
                  <span>Valor unitário:</span>
                  <span className="text-zinc-300">
                    {(() => {
                      let valor = 0;
                      if (modalEncadernacao.tipo === 'wireo') {
                        const item = wireoOptions.find(w => w.id === calcEncadernacao.selectedId);
                        if (item) valor = (calcEncadernacao.corEspecial ? item.preco_caixa_especial : item.preco_caixa_base) / item.quantidade_caixa;
                      } else {
                        const item = espiralOptions.find(e => e.id === calcEncadernacao.selectedId);
                        if (item) valor = item.preco_cento / 100;
                      }
                      return `R$ ${valor.toLocaleString('pt-BR', { minimumFractionDigits: 4 })}`;
                    })()}
                  </span>
                </div>
                <div className="flex justify-between text-[11px] text-zinc-400">
                  <span>Quantidade:</span>
                  <span className="text-zinc-300">{calcEncadernacao.quantidade}</span>
                </div>
                <div className="flex justify-between text-sm font-bold text-white border-t border-zinc-800 pt-2">
                  <span>Custo Total:</span>
                  <span className="text-blue-400">
                    {(() => {
                      let valor = 0;
                      if (modalEncadernacao.tipo === 'wireo') {
                        const item = wireoOptions.find(w => w.id === calcEncadernacao.selectedId);
                        if (item) valor = (calcEncadernacao.corEspecial ? item.preco_caixa_especial : item.preco_caixa_base) / item.quantidade_caixa;
                      } else {
                        const item = espiralOptions.find(e => e.id === calcEncadernacao.selectedId);
                        if (item) valor = item.preco_cento / 100;
                      }
                      return (valor * (calcEncadernacao.quantidade > 0 ? calcEncadernacao.quantidade : 1)).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    })()}
                  </span>
                </div>
              </div>

              {modalEncadernacao.tipo === 'wireo' && (
                <div className="flex items-center gap-3 p-3 bg-zinc-800/30 rounded-xl border border-zinc-800">
                  <input 
                    type="checkbox" 
                    id="corEspecial" 
                    className="w-4 h-4 accent-blue-600"
                    onChange={(e) => setCalcEncadernacao({ ...calcEncadernacao, corEspecial: e.target.checked })}
                  />
                  <label htmlFor="corEspecial" className="text-xs text-zinc-300 cursor-pointer">
                    Utilizar Cor Especial (Prata/Bronze/Cores)
                  </label>
                </div>
              )}

              <button
                type="button"
                onClick={aplicarCalculoEncadernacao}
                disabled={!calcEncadernacao.selectedId}
                className="w-full bg-blue-600 hover:bg-blue-700 disabled:opacity-50 text-white font-bold py-3 rounded-xl transition-all mt-4"
              >
                APLICAR VALOR
              </button>
            </div>
          </div>
        </div>
      )}

      {/* MODAL DA CALCULADORA */}
      {isModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4">
          <div className="bg-zinc-900 border border-zinc-800 p-6 rounded-2xl w-full max-w-md shadow-2xl animate-in fade-in zoom-in duration-200">
            <div className="flex justify-between items-center mb-6">
              <h3 className="text-white font-bold flex items-center gap-2">
                <Calculator className="text-blue-500" size={20} />
                Calculadora de Folhas
              </h3>
              <button
                type="button"
                onClick={() => { setIsModalOpen(false); setSearchTerm(''); }}
                className="text-zinc-500 hover:text-white transition-colors"
              >
                <X size={20} />
              </button>
            </div>

            <div className="space-y-4">
              <div>
                <label className="text-[10px] text-zinc-500 uppercase font-bold block mb-1">Buscar Insumo de Papel</label>
                <div className="relative">
                  <Search className="absolute left-3 top-3 text-zinc-500" size={16} />
                  <input
                    type="text"
                    placeholder="Digite pelo menos 4 letras..."
                    className="w-full bg-zinc-950 border border-zinc-700 rounded-lg p-2.5 pl-10 text-zinc-300 outline-none focus:border-blue-500"
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    onKeyDown={(e) => { if (e.key === 'Enter') e.preventDefault(); }}
                  />
                </div>

                <div className="mt-2 max-h-40 overflow-y-auto rounded-lg border border-zinc-800 bg-zinc-950 custom-scrollbar">
                  {searchTerm.length >= 4 ? (
                    papeisFiltrados.length > 0 ? (
                      papeisFiltrados.map(p => (
                        <button
                          key={p.id}
                          type="button"
                          onClick={() => {
                            setCalcParams({ ...calcParams, papelId: p.id });
                            setSearchTerm(p.nome);
                          }}
                          className={`w-full text-left px-4 py-2.5 text-sm transition-colors border-b border-zinc-900 last:border-0
                            ${calcParams.papelId === p.id
                              ? 'bg-blue-600/20 text-blue-400 font-bold'
                              : 'text-zinc-400 hover:bg-zinc-800 hover:text-white'
                            }`}
                        >
                          {p.nome}
                        </button>
                      ))
                    ) : (
                      <div className="p-4 text-center text-xs text-zinc-600 uppercase">Nenhum papel encontrado</div>
                    )
                  ) : (
                    <div className="p-4 text-center text-xs text-zinc-600 uppercase">Digite para pesquisar</div>
                  )}
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="text-[10px] text-zinc-500 uppercase font-bold block mb-1">Formato</label>
                  <select
                    className="w-full bg-zinc-950 border border-zinc-700 rounded-lg p-2.5 text-zinc-300 outline-none focus:border-blue-500 appearance-none cursor-pointer"
                    value={calcParams.formato}
                    onChange={(e) => setCalcParams({ ...calcParams, formato: e.target.value as keyof Omit<TipoPapel, 'id' | 'nome'> })}
                  >
                    {['f1', 'f2', 'f3', 'f4', 'f6', 'f8', 'f9'].map(f => (
                      <option key={f} value={f}>{f.toUpperCase()}</option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="text-[10px] text-zinc-500 uppercase font-bold block mb-1">Qtd. de Folhas</label>
                  <input
                    type="number"
                    min="1"
                    className="w-full bg-zinc-950 border border-zinc-700 rounded-lg p-2.5 text-zinc-300 outline-none focus:border-blue-500"
                    value={calcParams.quantidadeFolhas}
                    onChange={(e) => setCalcParams({ ...calcParams, quantidadeFolhas: Number(e.target.value) })}
                  />
                </div>
              </div>

              <div className="bg-blue-600/5 border border-blue-500/20 p-4 rounded-xl mt-4 space-y-2">
                <div className="flex justify-between text-[11px] text-zinc-400 italic">
                  <span>Papel selecionado:</span>
                  <span className="text-zinc-300">{tiposPapel.find(p => p.id === calcParams.papelId)?.nome || 'Nenhum'}</span>
                </div>
                <div className="flex justify-between text-[11px] text-zinc-400">
                  <span>Preço Unitário ({calcParams.formato.toUpperCase()}):</span>
                  <span>
                    R$ {tiposPapel.find(p => p.id === calcParams.papelId)?.[calcParams.formato]?.toFixed(4) || '0,0000'}
                  </span>
                </div>
                <div className="flex justify-between text-sm font-bold text-white border-t border-zinc-800 pt-2">
                  <span>Custo Total:</span>
                  <span className="text-blue-400">
                    {((tiposPapel.find(p => p.id === calcParams.papelId)?.[calcParams.formato] || 0) * calcParams.quantidadeFolhas).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}
                  </span>
                </div>
              </div>

              <button
                type="button"
                onClick={aplicarCalculoPapel}
                disabled={!calcParams.papelId}
                className="w-full bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3.5 rounded-xl transition-all shadow-lg active:scale-[0.98] mt-2"
              >
                Aplicar na Grade
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="app/dashboard/orcamentos/[id]/page.tsx">
export const dynamic = 'force-dynamic';

import { redirect } from 'next/navigation';
import { createClient } from "@/lib/supabase/server";
import { DashboardHeader } from '@/components/dashboard-header';
import { GradeOrcamento } from '@/components/orcamento/grade-orcamento';
import { HistoricoVersoes } from '@/components/orcamento/historico-versoes';
import { salvarFluxoOrcamento } from "../actions/salvarFluxoOrcamento";
import { atualizarTituloOrcamento } from "@/app/dashboard/orcamentos/actions/atualizarTitulo";
import { BotaoSalvar } from '@/components/ui/botaoSalvar';

export default async function OrcamentoPage({
    params,
    searchParams
}: {
    params: { id: string },
    searchParams: { v?: string, edit?: string }
}) {
    const { id } = await params;
    const { v: versaoIdSolicitada, edit } = await searchParams;
    const supabase = await createClient();

    const isVisualizandoHistorico = !!versaoIdSolicitada && edit !== 'true';

    const [
        { data: tiposPapel },
        { data: wireo },
        { data: espiral },
        { data: acessorios }
    ] = await Promise.all([
        supabase.from('tipos_papel').select('*').order('nome'),
        supabase.from('insumos_wireo').select('*').order('preco_caixa_base'),
        supabase.from('insumos_espiral').select('*').order('tamanho_mm'),
        supabase.from('insumos_acessorios').select('*').order('nome')
    ]);

    const { data: { user } } = await supabase.auth.getUser();
    if (!user) redirect('/autenticacao/entrar');

    const { data: clientes } = await supabase.from('clientes').select('id, nome').order('nome');

    let insumosParaGrade = [];
    let orcamentoExistente: { id: string; titulo: string; cliente_id: string } | null = null;
    let versoes = [];
    let quantidadesIniciais = [100]; // Padrão para novo orçamento é apenas 100

    // 1. Carrega SEMPRE todos os insumos base primeiro
    const { data: todosInsumosBase } = await supabase
        .from('insumos_base')
        .select('*')
        .order('categoria');

    if (id === 'novo') {
        // Para novo orçamento: todos os insumos com custo 0
        insumosParaGrade = todosInsumosBase?.map(i => ({
            ...i,
            id: String(i.id),
            custo_unitario: 0
        })) || [];
    } else {

        // BUSCAR COLUNAS SALVAS
        const { data: colunasSalvas } = await supabase
            .from('orcamento_colunas')
            .select('quantidade')
            .eq('orcamento_id', id)
            .order('ordem', { ascending: true });

        // Se houver colunas no banco, usa elas, senão usa [100]
        quantidadesIniciais = colunasSalvas && colunasSalvas.length > 0
            ? colunasSalvas.map(c => c.quantidade)
            : [100];

        const { data: orc } = await supabase.from('orcamentos').select('*').eq('id', id).single();
        const { data: vList } = await supabase.from('orcamento_versoes').select('*').eq('orcamento_id', id).order('versao_numero', { ascending: false });

        orcamentoExistente = orc;
        versoes = vList || [];

        // Se tiver v na URL, usa ela. Se não (ou se for ?edit=true vindo do dashboard), entre na tela de criar nova versão
        const versaoParaCarregar = versaoIdSolicitada
            ? versoes.find(v => v.id === versaoIdSolicitada)
            : null;

        if (versaoParaCarregar) {
            const { data: valoresSalvos } = await supabase
                .from('orcamento_versao_valores')
                .select('*')
                .eq('versao_id', versaoParaCarregar.id);


            // Mapeia TODOS os insumos base, injetando o valor salvo onde houver
            insumosParaGrade = (todosInsumosBase || []).map(base => {
                const valorSalvo = valoresSalvos?.find(v => v.insumo_id === base.id);
                return {
                    id: String(base.id),
                    nome: base.nome,
                    categoria: base.categoria || 'Geral',
                    // Se achou valor no banco, usa ele. Se não, custo 0 para o novo rascunho.
                    custo_unitario: valorSalvo ? valorSalvo.valor_custo_unitario_base : 0
                };
            });
        } else {
            // Fallback caso o orçamento exista mas não tenha versões (segurança)
            insumosParaGrade = todosInsumosBase?.map(i => ({ ...i, id: String(i.id), custo_unitario: 0 })) || [];
        }
    }

    async function handleSalvarVersao(formData: FormData) {
        'use server';
        const gradeDadosRaw = formData.get('grade_dados') as string;
        if (!gradeDadosRaw) return;
        const { markup, valores, quantidadesVisiveis } = JSON.parse(gradeDadosRaw);
        const tituloFinal = formData.get('titulo') as string || "Novo Orçamento";

        const payload = {
            titulo: tituloFinal,
            clienteId: formData.get('clienteId') as string,
            valores: valores,
            quantidadesVisiveis: quantidadesVisiveis,
            userId: user!.id,
            markup: markup,
            ...(id !== 'novo' ? { orcamentoId: id } : {}),
        };

        await salvarFluxoOrcamento(payload);
        redirect(`/dashboard/orcamentos/${id !== 'novo' ? id : ''}`);
    }

    async function handleUpdateTitle(formData: FormData) {
        'use server';
        const novoTitulo = formData.get('titulo') as string;
        if (id !== 'novo' && novoTitulo) {
            await atualizarTituloOrcamento(id, novoTitulo);
        }
    }

    return (
        <div className="max-w-7xl mx-auto py-8 px-4 md:px-8">
            <DashboardHeader />

            <main className="hidden sm:block max-w-7xl mx-auto px-6 py-8">
                <header className="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-6 bg-zinc-900/20 p-6 rounded-2xl border border-zinc-800/50">
                    <div className="flex-1 w-full group">
                        <label className="text-[10px] font-bold uppercase tracking-[0.2em] text-zinc-500 mb-1 block">
                            Nome do Orçamento
                        </label>
                        <form action={handleUpdateTitle} className="flex items-center gap-4">
                            <input
                                name="titulo"
                                // REMOVA A LINHA ABAIXO:
                                // form="form-principal" 
                                defaultValue={orcamentoExistente?.titulo}
                                placeholder="Ex: Cartão de Visita Premium..."
                                className="bg-transparent text-3xl font-black text-white border-b-2 border-transparent focus:border-blue-500 outline-none transition-all py-1 flex-1"
                                required
                                disabled={isVisualizandoHistorico}
                            />
                            {id !== 'novo' && !isVisualizandoHistorico && (
                                <button
                                    type="submit"
                                    className="px-4 py-2 rounded-lg bg-zinc-800 hover:bg-zinc-700 text-zinc-300 text-[10px] font-bold uppercase border border-zinc-700 transition"
                                >
                                    Atualizar Nome
                                </button>
                            )}
                        </form>
                    </div>
                </header>

                {versoes.length > 0 && (
                    <HistoricoVersoes
                        versoes={versoes}
                    />
                )}

                <form action={handleSalvarVersao} id="form-principal">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-end mb-8 gap-6">
                        <section className="bg-zinc-900/30 p-6 rounded-2xl border border-zinc-800/50 flex-1 w-full md:max-w-md">
                            <label className="text-[10px] font-bold uppercase text-zinc-500 mb-2 block tracking-widest">Cliente Associado</label>
                            <select
                                name="clienteId"
                                className="w-full bg-zinc-950 border border-zinc-800 rounded-xl p-4 outline-none appearance-none cursor-pointer text-sm disabled:opacity-50"
                                defaultValue={orcamentoExistente?.cliente_id || ""}
                                required
                                disabled={isVisualizandoHistorico}
                            >
                                <option value="" disabled>Selecione um cliente...</option>
                                {clientes?.map(c => <option key={c.id} value={c.id}>{c.nome}</option>)}
                            </select>
                        </section>

                        {/* Só exibe o botão salvar se não estiver visualizando histórico antigo */}
                        {!isVisualizandoHistorico && <BotaoSalvar />}
                    </div>

                    <GradeOrcamento
                        wireoOptions={wireo || []}
                        espiralOptions={espiral || []}
                        acessoriosOptions={acessorios || []}
                        tiposPapel={tiposPapel || []}
                        insumosIniciais={insumosParaGrade}
                        quantidadesPadrao={quantidadesIniciais}
                        markupInicial={30}
                        readOnly={isVisualizandoHistorico} // Passa o estado de leitura
                    />
                </form>
            </main>
        </div>
    );
}
</file>

</files>
